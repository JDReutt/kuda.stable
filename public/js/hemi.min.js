/*
 * Kuda includes a library and editor for authoring interactive 3D content for the web.
 * Copyright (C) 2011 SRI International.
 *
 * This program is free software; you can redistribute it and/or modify it under the terms
 * of the GNU General Public License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program;
 * if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 * Boston, MA 02110-1301 USA.
 */
o3djs.base.o3d=o3d;var hemi=function(a){return a.version="1.5.1",a.core=a.core||{},Array.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}),o3djs.material.createLambertMaterial=function(a,b,c,d){var e=a.createObject("Material");e.drawList=d?b.zOrderedDrawList:b.performanceDrawList;if(c.length)e.createParam("diffuse","ParamFloat4").value=c;else{var f=e.createParam("diffuseSampler","ParamSampler"),g=a.createObject("Sampler");f.value=g,g.texture=c}e.createParam("emissive","ParamFloat4").value=[0,0,0,1],e.createParam("ambient","ParamFloat4").value=[0,0,0,1],e.createParam("lightColor","ParamFloat4").value=[1,1,1,1];var h=e.createParam("lightWorldPos","ParamFloat3");return o3djs.material.attachStandardEffect(a,e,b,"lambert"),h.value=[1e3,2e3,3e3],e},a.core.error=function(a){if(this.errCallback)this.errCallback(a);else{var b=new Error(a);throw b.name="HemiError",b}},a.core.setErrorCallback=function(a){this.errCallback=a},a.core.init=function(b){this.event=o3djs.event,this.loader=o3djs.loader,this.math=o3djs.math,this.particles=o3djs.particles,this.renderGraph=o3djs.rendergraph,this.canvas=o3djs.canvas,this.material=o3djs.material,this.shape=o3djs.shape,this.picking=o3djs.picking,this.primitives=o3djs.primitives,this.io=o3djs.io,this.debug=o3djs.debug,this.o3dElement=b,this.o3d=this.o3dElement.o3d,this.client=this.o3dElement.client,this.mainPack=this.client.createPack(),this.errCallback=null,a.picking.init(),a.input.init(),a.view.init(),a.curve.init(),a.model.init(),a.effect.init(),a.hud.init(),a.shape.init(),a.sprite.init(),a.world.init()},a.core.loaderCallback=function(b){a.picking.pickManager.update(),o3djs.pack.preparePack(b,a.view.viewInfo);var c=b.getObjectsByClassName("o3d.Material"),d=a.world.fog;for(var e=0;e<c.length;++e){var f=c[e],g=f.getParam("lightWorldPos");g&&g.bind(a.world.camera.light.position),g=f.getParam("ambientIntensity"),g&&(g.value=[.3,.3,.3,.2]),g=f.getParam("ambient"),g&&(g.value=[.3,.3,.3,.2]),g=f.getParam("lightColor"),g&&g.bind(a.world.camera.light.color),f.drawList==a.view.viewInfo.zOrderedDrawList&&(f.drawList=a.view.viewInfo.performanceDrawList);if(d!==null){var h=a.fx.addFog(f);h.start.value=d.start,h.end.value=d.end,h.color.value=d.color}}},a}(hemi||{}),hemi=function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;return a.Class=function(){},a.Class.extend=function(a){function g(){!b&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;b=!0;var e=new this;b=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&c.test(a[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,a[f]):a[f];return g.prototype=e,g.constructor=g,g.extend=arguments.callee,g},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.Hashtable=Hashtable,a.utils.Hashtable.prototype.query=function(b){var c=this.values(),d=[],e=[],f=[],g,h,i,j,k,l,m,n;for(x in b)a.utils.isArray(b[x])?e.push(x):d.push(x);var o=d.length,p=e.length;for(var q=0,r=c.length;q<r;q++){g=c[q],n=!0;for(k=0;n&&k<o;k++)h=d[k],n=g[h]===b[h];for(k=0;n&&k<p;k++){n=!1,h=e[k],i=g[h],j=b[h],m=j.length;for(l=0;!n&&l<m;l++)n=i===j[l]}n&&f.push(g)}return f},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.clone=function(b,c){var d=a.utils.isArray(b)?[]:{},c=c==null?!0:c;return a.utils.join(d,b,c),d},a.utils.compareArrays=function(b,c){var d=b.length===c.length;for(var e=0;d&&e<b.length;e++)b[e]instanceof Array?d=a.utils.compareArrays(b[e],c[e]):d=Math.abs(b[e]-c[e])<=.001;return d},a.utils.get=function(b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){if(this.readyState===4){this.onreadystatechange=a.utils.noop;var b=null;if(this.status===200||window.location.href.indexOf("http")===-1){var d=this.getResponseHeader("content-type");d&&d.indexOf("xml")>=0?b=this.responseXML:b=this.responseText}c(b,this.statusText)}},d.open("GET",b,!0);try{d.send(null)}catch(e){c(null,e.name+": "+e.message)}},a.utils.isArray=Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},a.utils.join=function(){var b=arguments[0],c=arguments.length,d=arguments[c-1],e=!0;typeof d=="boolean"&&(e=d,--c);for(var f=1;f<c;f++){var g=arguments[f];for(var h in g){var i=g[h];if(e&&i!=null&&typeof i=="object"){var j=b[h],k=a.utils.isArray(i);if(j==null||typeof j!="object"||a.utils.isArray(j)!==k)j=k?[]:{};b[h]=a.utils.join(j,i)}else b[h]=i}}return b},a.utils.noop=function(){},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.cartesianToSpherical=function(a){var b=a[0],c=a[1],d=a[2],e=Math.sqrt(b*b+c*c+d*d),f=Math.acos(c/e),g=Math.atan2(b,d);return[e,f,g]},a.utils.choose=function(b,c){return a.utils.factorial(b,b-c+1)/a.utils.factorial(c)},a.utils.clamp=function(a,b,c){return Math.min(c,Math.max(b,a))},a.utils.cubicHermite=function(a,b,c,d,e){var f=a*a,g=f*a,h=2*g-3*f+1,i=g-2*f+a,j=-2*g+3*f,k=g-f;return h*b+i*c+j*d+k*e},a.utils.factorial=function(a,b){var c=1,d=b?b:2;while(d<=a)c*=d++;return c},a.utils.intersect=function(b,c){var d=c,e=[b.near,b.far],f=a.core.math.inverse([[e[0][0]-e[1][0],d[1][0]-d[0][0],d[2][0]-d[0][0]],[e[0][1]-e[1][1],d[1][1]-d[0][1],d[2][1]-d[0][1]],[e[0][2]-e[1][2],d[1][2]-d[0][2],d[2][2]-d[0][2]]]),g=[e[0][0]-d[0][0],e[0][1]-d[0][1],e[0][2]-d[0][2]],h=f[0][0]*g[0]+f[0][1]*g[1]+f[0][2]*g[2],i=f[1][0]*g[0]+f[1][1]*g[1]+f[1][2]*g[2],j=f[2][0]*g[0]+f[2][1]*g[1]+f[2][2]*g[2];return[h,i,j]},a.utils.linearToSine=function(a){return(Math.sin(Math.PI*a-Math.PI/2)+1)/2},a.utils.linearToParabolic=function(a){return a*a},a.utils.linearToParabolicInverse=function(a){return 1-(1-a)*(1-a)},a.utils.linearToExponential=function(a,b){return(Math.pow(b,a)-1)/(b-1)},a.utils.linearToExponentialInverse=function(b,c){return 1-a.utils.linearToExponential(1-b,c)},a.utils.penner={linearTween:function(a,b,c,d){return c*a/d+b},easeInQuad:function(a,b,c,d){return a/=d,c*a*a+b},easeOutQuad:function(a,b,c,d){return a/=d,-c*a*(a-2)+b},easeInOutQuad:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)},easeInCubic:function(a,b,c,d){return a/=d,c*a*a*a+b},easeOutCubic:function(a,b,c,d){return a/=d,a--,c*(a*a*a+1)+b},easeInOutCubic:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a+b:(a-=2,c/2*(a*a*a+2)+b)},easeInQuart:function(a,b,c,d){return a/=d,c*a*a*a*a+b},easeOutQuart:function(a,b,c,d){return a/=d,a--,-c*(a*a*a*a-1)+b},easeInOutQuart:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a+b:(a-=2,-c/2*(a*a*a*a-2)+b)},easeInQuint:function(a,b,c,d){return a/=d,c*a*a*a*a*a+b},easeOutQuint:function(a,b,c,d){return a/=d,a--,c*(a*a*a*a*a+1)+b},easeInOutQuint:function(a,b,c,d){return a/=d/2,a<1?c/2*a*a*a*a*a+b:(a-=2,c/2*(a*a*a*a*a+2)+b)},easeInSine:function(a,b,c,d){return-c*Math.cos(a/d*(Math.PI/2))+c+b},easeOutSine:function(a,b,c,d){return c*Math.sin(a/d*(Math.PI/2))+b},easeInOutSine:function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},easeInExpo:function(a,b,c,d){return c*Math.pow(2,10*(a/d-1))+b},easeOutExpo:function(a,b,c,d){return c*(-Math.pow(2,-10*a/d)+1)+b},easeInOutExpo:function(a,b,c,d){return a/=d/2,a<1?c/2*Math.pow(2,10*(a-1))+b:(a--,c/2*(-Math.pow(2,-10*a)+2)+b)},easeInCirc:function(a,b,c,d){return a/=d,-c*(Math.sqrt(1-a*a)-1)+b},easeOutCirc:function(a,b,c,d){return a/=d,a--,c*Math.sqrt(1-a*a)+b},easeInOutCirc:function(a,b,c,d){return a/=d/2,a<1?-c/2*(Math.sqrt(1-a*a)-1)+b:(a-=2,c/2*(Math.sqrt(1-a*a)+1)+b)}},a.utils.sphericalToCartesian=function(a){var b=a[0],c=a[1],d=a[2];return[b*Math.sin(c)*Math.cos(d),b*Math.sin(c)*Math.sin(d),b*Math.cos(c)]},a.utils.uvToXYZ=function(b,c){var d=a.core.math,e=d.mulScalarVector(b[0],d.subVector(c[1],c[0])),f=d.mulScalarVector(b[1],d.subVector(c[2],c[0]));return pos=d.addVector(c[0],d.addVector(e,f)),pos},a.utils.worldToScreen=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[Math.round(k),Math.round(l)]},a.utils.worldToScreenFloat=function(b){var c=a.view.viewInfo.drawContext.view,d=a.view.viewInfo.drawContext.projection,e=a.view.clientSize.width,f=a.view.clientSize.height,g=a.core.math.matrix4,h=g.transformPoint(c,b),i=h[2],j=g.transformPoint(d,h);i>0&&(j[0]=-j[0],j[1]=-j[1]);var k=(j[0]+1)*.5*e,l=(-j[1]+1)*.5*f;return[k,l,j[2]]},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.buildSrc=function(a){var b=(a.preHdr?a.preHdr:"")+(a.hdr?a.hdr:"")+(a.postHdr?a.postHdr:"")+(a.preSprt?a.preSprt:"")+(a.sprt?a.sprt:"")+(a.postSprt?a.postSprt:"")+a.main+(a.preBody?a.preBody:"")+(a.body?a.body:"")+(a.postBody?a.postBody:"")+(a.preGlob?a.preGlob:"")+(a.glob?a.glob:"")+(a.postGlob?a.postGlob:"")+a.end;return b},a.utils.combineFragSrc=function(a,b){return this.combineSrc(a,b,"gl_FragColor")},a.utils.combineSrc=function(b,c,d){var e=this.parseSrc(b,d);return a.utils.join(e,c),this.buildSrc(e)},a.utils.combineVertSrc=function(a,b){return this.combineSrc(a,b,"gl_Position")},a.utils.getShaders=function(a){var b=a.gl,c=a.effect.program_,d=b.getAttachedShaders(c),e=b.getShaderSource(d[0]),f=b.getShaderSource(d[1]),g;return e.search("gl_FragColor")>0?g={fragShd:d[0],fragSrc:e,vertShd:d[1],vertSrc:f}:g={fragShd:d[1],fragSrc:f,vertShd:d[0],vertSrc:e},g},a.utils.parseSrc=function(a,b){var c=a.lastIndexOf(";",a.indexOf("{"))+1,d=a.indexOf("void main",c),e=a.indexOf("{",d)+1,f=a.indexOf(b,e),g=a.lastIndexOf(";")+1;a.charAt(c)==="\n"&&++c,a.charAt(e)==="\n"&&++e,a.charAt(f)==="\n"&&++f,a.charAt(g)==="\n"&&++g;var h={hdr:a.slice(0,c),sprt:a.slice(c,d),main:a.slice(d,e),body:a.slice(e,f),glob:a.slice(f,g),end:a.slice(g)};return h},a}(hemi||{}),hemi=function(a){function c(a,c,d){var e=c,f=0,g=a.length,h=c-Math.max(c-d,0),i=Math.min(c+d,g-1)-c,j,k;for(var l=parseInt(c-h);l<=c+i;l++){k=b.get(a.charAt(l));if(k===null)continue;j=k/Math.abs(c-l),j>f&&(e=l,f=j)}return Math.min(e+1,g-1)}a.utils=a.utils||{},String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},a.utils.isNumeric=function(a){return a!==null&&!isNaN(a)&&a.length!==0};var b=new Hashtable;return b.put(" ",10),b.put(",",20),b.put(";",30),b.put(".",10),b.put("!",40),b.put("?",40),a.utils.wrapTextStrict=function(c,d,e){var f=[],c=a.utils.cleanseText(c),g=c.length,h=e.measureText(c),i=h.width/g,j=Math.floor(d/i),k=Math.ceil(j/10),l=0,m=j,n,o;while(m<g){n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o<d&&m<g)m+=k,m>g&&(m=g),n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;while(o>d)m--,n=c.substring(l,m).trim(),h=e.measureText(n),o=h.width;var p=m-1,q=c.charAt(p);while(!b.containsKey(q)&&p>l)p--,q=c.charAt(p);p>l&&(m=p+1),n=c.substring(l,m).trim(),f.push(n),l=m,m+=j}if(l!=g||f.length===0)n=c.substring(l,g).trim(),f.push(n);return f},a.utils.wrapText=function(b,d,e){var f=[],b=a.utils.cleanseText(b),g=b.length,h=parseInt(d/e),i=Math.ceil(g/h),j=h,k=0,l;for(var m=0;m<i-1;m++)l=k,k=c(b,j,10),f.push(b.substring(l,k).trim()),j=k+h;return f.push(b.substring(k,g)),f},a.utils.cleanseText=function(a){return a=a.replace("\n"," "),a},a}(hemi||{}),hemi=function(a){return a.utils=a.utils||{},a.utils.isAnimated=function(a){var b=a.getParam("o3d.localMatrix");return b.inputConnection!=null},a.utils.fosterTransform=function(b){var c=b.children,d=b.shapes,e=a.core.mainPack.createObject("Transform");while(c.length>0)c[0].parent=e;e.parent=b;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return e},a.utils.pointAsLocal=function(b,c){var d=a.core.math.matrix4,e=d.inverse(b.getUpdatedWorldMatrix());return d.transformPoint(e,c)},a.utils.pointAsWorld=function(b,c){var d=a.core.math.matrix4;return d.transformPoint(b.getUpdatedWorldMatrix(),c)},a.utils.pointYAt=function(b,c,d){var e=d[0]-c[0],f=d[1]-c[1],g=d[2]-c[2],h=Math.sqrt(e*e+g*g),i=Math.atan2(e,g),j=Math.atan2(h,f);return b.rotateY?(b.rotateY(i),b.rotateX(j)):(a.core.math.matrix4.rotateY(b,i),a.core.math.matrix4.rotateX(b,j)),b},a.utils.pointZAt=function(b,c,d){var e=a.core.math.subVector(d,c),f=Math.atan2(e[0],e[2]),g=-Math.asin(e[1]/a.core.math.length(e));return b.rotateY?(b.rotateY(f),b.rotateX(g)):(a.core.math.matrix4.rotateY(b,f),a.core.math.matrix4.rotateX(b,g)),b},a.utils.unfosterTransform=function(b){var c=b.children,d=b.shapes,e=b.parent;while(c.length>0)c[0].parent=e;while(d.length>0){var f=d[0];e.addShape(f),b.removeShape(f)}return b.parent=null,a.core.mainPack.removeObject(b),e},a.utils.worldRotate=function(b,c,d){var e=a.core.math.matrix4,f=e.inverse(d.getUpdatedWorldMatrix()),g=e.transformDirection(f,b);d.axisRotate(g,c)},a.utils.worldScale=function(b,c){var d=a.core.math.matrix4,e=d.mul(d.mul(d.mul(c.getUpdatedWorldMatrix(),d.scaling(b)),d.inverse(c.getUpdatedWorldMatrix())),c.localMatrix);c.localMatrix=e},a.utils.worldTranslate=function(b,c){var d=a.core.math.matrix4,e=d.inverse(c.getUpdatedWorldMatrix()),f=d.transformDirection(e,b);c.translate(f)},a}(hemi||{}),hemi=function(a){return a.msg={animate:"hemi.animate",burst:"hemi.burst",cleanup:"hemi.cleanup",drag:"hemi.drag",enable:"hemi.enable",load:"hemi.load",pick:"hemi.pick",progress:"hemi.progress",ready:"hemi.ready",scale:"hemi.scale",start:"hemi.start",stop:"hemi.stop",unload:"hemi.unload",visible:"hemi.visible",subscribe:function(b,c,d,e){return a.dispatch.registerTarget(a.dispatch.WILDCARD,b,c,d,e)},unsubscribe:function(b,c){return a.dispatch.removeTarget(b,{src:a.dispatch.WILDCARD,msg:c})}},a}(hemi||{}),hemi=function(a){a.console=a.console||{},a.console.ERR="ERR",a.console.WARN="WARN",a.console.LOG="LOG";var b=!1,c=!0,d=function(b,d){d=d||a.console.LOG;if(j(d)){var g=d+":\t"+b;if(c){var h=f();g=h+"\t"+g}e(g)}},e=function(a){try{console.log(a)}catch(b){}},f=function(){var a=new Date,b=a.getHours();b=b<10?"0"+b:""+b;var c=a.getMinutes();c=c<10?":0"+c:":"+c;var d=a.getSeconds();return d=d<10?":0"+d:":"+d,b+c+d},g=function(b){return b===a.console.LOG||b===a.console.WARN||b===a.console.ERR},h=function(b){return b===a.console.WARN||b===a.console.ERR},i=function(b){return b===a.console.ERR},j=g;return a.console.log=a.utils.noop,a.console.setEnabled=function(c){if(c==b)return;b=c,b?a.console.log=d:a.console.log=a.utils.noop},a.console.setOutput=function(a){e=a},a.console.setPriority=function(b){switch(b){case a.console.LOG:j=g;break;case a.console.WARN:j=h;break;case a.console.ERR:j=i}},a.console.setShowTime=function(a){c=a},a}(hemi||{}),hemi=function(a){a.picking=a.picking||{},a.picking.PICK_ROOT="PickRoot",a.picking.getPickInfo=function(b){var c=a.core.picking.clientPositionToWorldRay(b.x,b.y,a.view.viewInfo.drawContext,a.core.client.width,a.core.client.height);return this.pickManager.update(),this.pickManager.pick(c)},a.picking.setPickable=function(a,b,c){var d=this.pickManager.getTransformInfo(a);d&&d.setPickable(b,c)},a.picking.init=function(){this.pickRoot=a.core.mainPack.createObject("Transform"),this.pickRoot.name=a.picking.PICK_ROOT,this.pickRoot.parent=a.core.client.root,this.pickManager=a.core.picking.createPickManager(this.pickRoot),this.pickManager.createTransformInfo=function(a,b){var c=new o3djs.picking.TransformInfo(a,b,this);return c.pickable=!0,c.pickableEvenIfInvisible=!0,this.addTransformInfo(c),c}},o3djs.picking.TransformInfo.prototype.setPickable=function(a,b){this.pickable=a;if(b)for(var c in this.childTransformInfos)this.childTransformInfos[c].setPickable(a,b)};var b=o3djs.picking.TransformInfo.prototype.pick;return o3djs.picking.TransformInfo.prototype.pick=function(a){var c=null;this.pickable||(c=this.shapeInfos,this.shapeInfos={});var d=b.call(this,a);return this.pickable||(this.shapeInfos=c),d},a}(hemi||{}),hemi=function(a){a.loader=a.loader||{},a.loader.loadPath="";var b=new Hashtable,c=function(b,c){var e=a.loader.createTask(b,c);e&&d(b,c)},d=function(b,c){c.request_.addProgressListener(function(c){if(c.lengthComputable){var d=c.loaded/c.total*100;a.loader.updateTask(b,d)}})};return a.loader.loadHtml=function(b,c){b=a.loader.getPath(b),a.utils.get(b,function(b,d){b==null?a.core.error(d):c(b)})},a.loader.loadBitmap=function(b,d,e){b=a.loader.getPath(b),a.world.loader.loadBitmaps(d,b,function(c,d){a.loader.updateTask(b,100),d?a.core.error(d):e(c)});var f=a.world.loader.loadInfo.children_,g=f[f.length-1];c(b,g)},a.loader.loadImage=function(b,c){++a.world.loader.count_;var d=new Image;d.onabort=function(){a.core.error("Aborted loading: "+b),a.world.loader.countDown_()},d.onerror=function(){a.core.error("Error loading: "+b),a.world.loader.countDown_()},d.onload=function(){c(d),a.world.loader.countDown_()},d.src=a.loader.getPath(b)},a.loader.loadTexture=function(b,d,e,f){b=a.loader.getPath(b);var g=f||a.core.mainPack;a.world.loader.loadTexture(g,b,function(c,f){a.loader.updateTask(b,100),f?a.core.error(f):d.call(e,c)});var h=a.world.loader.loadInfo.children_,i=h[h.length-1];c(b,i)},a.loader.loadModel=function(b,d,e,f,g,h){b=a.loader.getPath(b),g=g||{},h=h||a.core.error;try{a.world.loader.loadScene(a.core.client,d,e,b,function(c,d,e){a.loader.updateTask(b,100),e?h(e):f&&f(c,d)},g);var i=a.world.loader.loadInfo.children_,j=i[i.length-1];c(b,j)}catch(k){h(k)}},a.loader.loadOctane=function(b,c){b=a.loader.getPath(b),a.utils.get(b,function(b,d){if(b==null)a.core.error(d);else{typeof b=="string"&&(b=JSON.parse(b));if(b.type){var e=a.octane.createObject(b);c&&c(e)}else a.octane.createWorld(b),c&&c(),a.world.ready()}})},a.loader.getPath=function(b){return b.substr(0,4)==="http"?b:a.loader.loadPath+b},a.loader.createTask=function(a,c){if(b.get(a)!==null)return!1;var d={percent:0,data:c};return b.put(a,d),this.updateTotal(),!0},a.loader.updateTask=function(c,d){var e=b.get(c),f=e!==null;return f&&(e.percent=d,a.world.send(a.msg.progress,{task:c,percent:d,isTotal:!1}),a.loader.updateTotal()),f},a.loader.updateTotal=function(){var c=b.size(),d=b.values(),e=0;for(var f=0;f<c;f++)e+=d[f].percent;return c>0&&(e/=c),a.world.send(a.msg.progress,{task:"Total Progress",isTotal:!0,percent:e}),e>=99.9&&b.clear(),e},a}(hemi||{}),hemi=function(a){return a.Accessibility=function(){this.init()},a.Accessibility.prototype={currentSelectionItem:0,selectionList:new Array,selectionTrigger:null,mapKey:function(b,c){a.input.addKeyDownListener({onKeyDown:function(a){a.keyCode==b&&c.down()}}),a.input.addKeyUpListener({onKeyUp:function(a){a.keyCode==b&&c.up()}})},init:function(){a.input.addKeyDownListener(this),a.input.addKeyUpListener(this)},onKeyUp:function(a){a.keyCode==13&&this.selectionList[this.currentSelectionItem].up()},onKeyDown:function(a){a.keyCode==this.selectionTrigger&&this.cycleSelectionItems(),a.keyCode==13&&this.selectionList[this.currentSelectionItem].down()},setCycleTrigger:function(a){this.selectionTrigger=a},cycleSelectionItems:function(){this.currentSelectionItem<this.selectionList.length-1?this.currentSelectionItem++:(this.selectionList[this.selectionList.length-1].deselect(),this.currentSelectionItem=0),this.selectionList[this.currentSelectionItem-1]&&this.selectionList[this.currentSelectionItem-1].deselect(),this.selectionList[this.currentSelectionItem].select()},addSelectionItem:function(a){this.selectionList.push(a)},removeSelectionItem:function(a){this.selectionList.splice(a,1)}},a}(hemi||{}),hemi=function(a){a.world=a.world||{};var b=50;a.world.WORLD_ID=0;var c=b,d=function(){return a.core.loader.createLoader(function(){a.world.loader=a.core.loader.createLoader(function(){a.console.log("Backup world loader is finished.")}),a.world.send(a.msg.ready,{})})},e=function(b){var c;switch(b){case a.world.WORLD_ID:c=a.world;break;default:c=null}return c};return a.world.Citizen=a.Class.extend({init:function(){this.name="",this.worldId=null,a.world.addCitizen(this)},citizenType:"hemi.world.Citizen",msgSent:[a.msg.cleanup],getCitizenType:function(){return this.citizenType},setCitizenType:function(a){this.citizenType=a},getId:function(){return this.worldId},setId:function(b){var c=this.worldId;this.worldId=b,c!==null&&(a.world.citizens.remove(c),a.world.citizens.put(b,this))},cleanup:function(){this.send(a.msg.cleanup,{}),a.world.removeCitizen(this)},receiveTransform:function(b){a.console.log("Transform ignored by Citizen with id "+this.worldId,a.console.WARN)},subscribe:function(b,c,d,e){return a.dispatch.registerTarget(this.worldId,b,c,d,e)},subscribeAll:function(b,c,d){return a.dispatch.registerTarget(this.worldId,a.dispatch.WILDCARD,b,c,d)},unsubscribe:function(b,c){return a.dispatch.removeTarget(b,{src:this.worldId,msg:c})},send:function(b,c){a.dispatch.postMessage(this,b,c)},toOctane:function(){var a={id:this.worldId,type:this.citizenType,props:[]};return this.name.length>0&&a.props.push({name:"name",val:this.name}),a}}),a.world.TransformOwner=a.Class.extend({init:function(){this.citizen=null,this.entries=new Hashtable,this.toLoad=null},distribute:function(){this.toLoad!==null&&this.load(),this.entries.each(function(a,b){var c=b.transform,d=b.targets;for(var e=0,f=d.length;e<f;e++)d[e].receiveTransform(c)})},getEntry:function(a){var b=this.entries.get(a.name);return b===null&&(b={transform:a,targets:[]},this.entries.put(a.name,b)),b},load:function(){var b=this.citizen,c=this.toLoad;for(var d=0,e=c.length;d<e;d++){var f=c[d],g=null;if(b.getTransform!=null)g=b.getTransform();else if(b.getTransforms!=null){var h=b.getTransforms(f.name);h.length===1&&(g=h[0])}if(g!=null){var i=this.getEntry(g),j=f.tIds;for(var k=0,l=j.length;k<l;k++){var m=a.world.getCitizenById(j[k]);m!=null?i.targets.push(m):a.console.log("Unable to locate Citizen with id "+j[k],a.console.WARN)}}else a.console.log("Unable to load entry with name "+f.name+" for TransformOwner with name "+this.citizen.name,a.console.ERR)}this.toLoad=null},register:function(a,b){var c=this.getEntry(a),d=c.targets.indexOf(b);d===-1&&c.targets.push(b)},toOctane:function(){var a={type:"hemi.world.TransformOwner",props:[{name:"citizen",id:this.citizen.getId()}]},b=[];return this.entries.each(function(a,c){var d=c.targets,e=[];for(var f=0,g=d.length;f<g;f++)e.push(d[f].getId());b.push({name:a,tIds:e})}),a.props.push({name:"toLoad",val:b}),a},unregister:function(a,b){var c=this.getEntry(a),d=c.targets.indexOf(b);d!==-1&&(c.targets.splice(d,1),c.targets.length===0&&this.entries.remove(a.name))}}),a.world.TransformRegistry=a.Class.extend({init:function(){this.owners=new Hashtable,this.toLoad=null},distribute:function(a){this.toLoad!==null&&this.load();var b=this.owners.get(a.getId());b!==null&&b.distribute()},getOwner:function(b){var c=b.getId(),d=this.owners.get(c);return d===null&&(d=new a.world.TransformOwner,d.citizen=b,this.owners.put(c,d)),d},load:function(){var b=this.toLoad;for(var c=0,d=b.length;c<d;c++){var e=b[c],f=e.citizen;f?this.owners.put(e.citizen.getId(),e):a.console.log("TransformOwner has null citizen.",a.console.ERR)}this.toLoad=null},register:function(b,c){var d=b.getParam("ownerId");if(d!==null){var e=a.world.getCitizenById(d.value),f=this.getOwner(e);f.register(b,c)}},toOctane:function(){var a={type:"hemi.world.TransformRegistry",props:[]},b=[];return this.owners.each(function(a,c){b.push(c.toOctane())}),a.props.push({name:"toLoad",oct:b}),a},unregister:function(b,c){var d=b.getParam("ownerId"),e=null;if(d!==null){var f=a.world.getCitizenById(d.value);f!==null&&(e=this.getOwner(f))}e!==null&&(e.unregister(b,c),e.entries.length===0&&this.owners.remove(d.value))}}),a.world.citizens=new a.utils.Hashtable,a.world.loader=null,a.world.camCallbacks=[],a.world.pickGrabber=null,a.world.tranReg=new a.world.TransformRegistry,a.world.fog=null,a.world.msgSent=[a.msg.cleanup,a.msg.pick,a.msg.ready],a.world.camera=null,a.world.setNextId=function(a){c=a},a.world.getNextId=function(){return c++},a.world.checkNextId=function(){return c},a.world.getId=function(){return a.world.WORLD_ID},a.world.toOctane=function(b){var d={version:a.version,nextId:c,camera:this.camera.getId(),citizens:[],fog:this.fog};return this.citizens.each(function(c,e){var f=b?b(e):!0;if(f){var g=e.toOctane();g!==null?d.citizens.push(g):a.console.log("Null Octane returned by Citizen with id "+e.getId(),a.console.WARN)}}),d.dispatch=a.dispatch.toOctane(),d.tranReg=this.tranReg.toOctane(),d},a.world.ready=function(){this.loader.finish()},a.world.cleanup=function(){this.send(a.msg.cleanup,{}),this.loader.finish(),this.loader=d(),this.fog!==null&&this.clearFog(),this.citizens.each(function(a,b){b.cleanup()}),this.citizens.size()>0&&a.console.log("World cleanup did not remove all citizens.",a.console.ERR),c=b,this.camera=null,this.setCamera(new a.view.Camera),this.pickGrabber=null},a.world.onMouseDown=function(b){var c=a.picking.getPickInfo(b);c&&(this.pickGrabber!=null?this.pickGrabber.onPick(c):this.send(a.msg.pick,{mouseEvent:b,pickInfo:c}))},a.world.addCamCallback=function(a){this.camCallbacks.indexOf(a)===-1&&this.camCallbacks.push(a)},a.world.removeCamCallback=function(a){var b=this.camCallbacks.indexOf(a);b!==-1&&this.camCallbacks.splice(b,1)},a.world.setPickGrabber=function(a){this.pickGrabber=a},a.world.removePickGrabber=function(){var a=this.pickGrabber;return this.pickGrabber=null,a},a.world.setCamera=function(a){this.camera&&this.camera.cleanup(),this.camera=a;if(a!==null){a.name="World Cam";for(var b=0,c=this.camCallbacks.length;b<c;b++)this.camCallbacks[b](a)}},a.world.addCitizen=function(b){var c=b.getId();c==null&&(c=this.getNextId(),b.setId(c));var d=this.citizens.get(c);d!==null&&(a.console.log("Citizen with id "+c+" already exists.",a.console.ERR),d.cleanup()),this.citizens.put(c,b)},a.world.removeCitizen=function(b){var c=b.getId(),d=this.citizens.remove(c);return d===null&&a.console.log("Unable to remove Citizen with id "+c,a.console.WARN),d!==null},a.world.getCitizens=function(a,c){var d={};if(a!=undefined){if(a.worldId!==undefined){if(a.worldId<b)return e(a.worldId);d.worldId=a.worldId}a.name!==undefined&&(d.name=a.name),a.citizenType!==undefined&&(d.citizenType=a.citizenType)}var f=this.citizens.query(d);if(c)for(var g=0,h=f.length;g<h;g++)c(f[g])||(f.splice(g,1),g--,h--);return f},a.world.getCitizenById=function(c){var d;return c<b?d=e(c):d=this.citizens.get(c),d===null&&a.console.log("Tried to get Citizen with id "+c+", returned null.",a.console.ERR),d},a.world.getAudio=function(b,c){return b=b||{},b.citizenType=a.audio.Audio.prototype.citizenType,this.getCitizens(b,c)},a.world.getCamCurves=function(b,c){return b=b||{},b.citizenType=a.view.CameraCurve.prototype.citizenType,this.getCitizens(b,c)},a.world.getHudDisplays=function(b,c){return b=b||{},b.citizenType=a.hud.HudDisplay.prototype.citizenType,this.getCitizens(b,c)},a.world.getHudElements=function(b,c){return b=b||{},b.citizenType=a.hud.HudElement.prototype.citizenType,this.getCitizens(b,c)},a.world.getModels=function(b,c){return b=b||{},b.citizenType=a.model.Model.prototype.citizenType,this.getCitizens(b,c)},a.world.getAnimations=function(b,c){return b=b||{},b.citizenType=a.animation.Animation.prototype.citizenType,this.getCitizens(b,c)},a.world.getEffects=function(b,c){var d=[];return b=b||{},b.citizenType=a.effect.Emitter.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Burst.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),b.citizenType=a.effect.Trail.prototype.citizenType,d=d.concat(this.getCitizens(b,c)),d},a.world.getViewpoints=function(b,c){return b=b||{},b.citizenType=a.view.Viewpoint.prototype.citizenType,this.getCitizens(b,c)},a.world.getPressureEngines=function(a,b){return a=a||{},a.citizenType=hext.engines.PressureEngine.prototype.citizenType,this.getCitizens(a,b)},a.world.getDraggables=function(b,c){return b=b||{},b.citizenType=a.manip.Draggable.prototype.citizenType,this.getCitizens(b,c)},a.world.getTurnables=function(b,c){return b=b||{},b.citizenType=a.manip.Turnable.prototype.citizenType,this.getCitizens(b,c)},a.world.getRotators=function(b,c){return b=b||{},b.citizenType=a.motion.Rotator.prototype.citizenType,this.getCitizens(b,c)},a.world.getScenes=function(b,c){return b=b||{},b.citizenType=a.scene.Scene.prototype.citizenType,this.getCitizens(b,c)},a.world.getTimers=function(b,c){return b=b||{},b.citizenType=a.time.Timer.prototype.citizenType,this.getCitizens(b,c)},a.world.getTranslators=function(b,c){return b=b||{},b.citizenType=a.motion.Translator.prototype.citizenType,this.getCitizens(b,c)},a.world.getShapes=function(b,c){return b=b||{},b.citizenType=a.shape.Shape.prototype.citizenType,this.getCitizens(b,c)},a.world.getTranOwner=function(a){var b=a.getParam("ownerId"),c=null;return b!==null&&(c=this.getCitizenById(b.value)),c},a.world.send=function(b,c){a.dispatch.postMessage(a.world,b,c)},a.world.subscribe=function(b,c,d,e){return a.dispatch.registerTarget(a.world.WORLD_ID,b,c,d,e)},a.world.unsubscribe=function(b,c){return a.dispatch.removeTarget(b,{src:a.world.WORLD_ID,msg:c})},a.world.clearFog=function(){var b=a.view.defaultBG;start=this.camera.clip.far,end=start+10,this.setFog(b,start,end),this.fog=null},a.world.setFog=function(b,c,d){var e=[],f=a.world.getModels();for(var g=0;g<f.length;g++)e=e.concat(f[g].materials);e=e.concat(a.core.mainPack.getObjectsByClassName("o3d.Material"));for(g=0;g<e.length;g++){var h=a.fx.addFog(e[g]);h.start.value=c,h.end.value=d,h.color.value=b}a.view.setBGColor(b),this.fog={color:b,start:c,end:d}},a.world.init=function(){c=b,a.world.loader=d(),a.world.setCamera(new a.view.Camera),a.input.addMouseDownListener(this)},a}(hemi||{}),hemi=function(hemi){return hemi.octane=hemi.octane||{},hemi.octane.createWorld=function(a){hemi.world.cleanup();var b=a.citizens.length,c=b*-2;hemi.world.setNextId(c);for(var d=0;d<b;d++){var e=a.citizens[d];e.id===a.camera&&hemi.world.setCamera(null);var f=hemi.octane.createObject(e);e.id===a.camera&&hemi.world.setCamera(f)}hemi.world.setNextId(a.nextId);if(a.fog!=null){var g=a.fog;hemi.world.setFog(g.color,g.start,g.end)}var h=a.dispatch.ents,i=[];for(var d=0,j=h.length;d<j;d++){var k=hemi.octane.createObject(h[d]);hemi.octane.setProperties(k,h[d]),i.push(k)}hemi.dispatch.loadEntries(i),hemi.dispatch.setNextId(a.dispatch.nextId),hemi.world.tranReg=hemi.octane.createObject(a.tranReg),hemi.octane.setProperties(hemi.world.tranReg,a.tranReg);for(var d=0;d<b;d++){var e=a.citizens[d];hemi.octane.setProperties(hemi.world.getCitizenById(e.id),e)}},hemi.octane.createObject=function(octane){if(!octane.type)return alert("Unable to process octane: missing type"),null;var object=eval("new "+octane.type+"();");return octane.id!==undefined&&object.setId(octane.id),object},hemi.octane.setProperties=function(a,b){for(var c=0,d=b.props.length;c<d;c++){var e=b.props[c],f=e.name;if(e.oct!==undefined){if(e.oct instanceof Array){j=[];for(var g=0,h=e.oct.length;g<h;g++){var i=hemi.octane.createObject(e.oct[g]);hemi.octane.setProperties(i,e.oct[g]),j.push(i)}}else j=hemi.octane.createObject(e.oct),hemi.octane.setProperties(j,e.oct);a[f]=j}else if(e.val!==undefined)a[f]=e.val;else if(e.id!==undefined){var j;if(e.id instanceof Array){j=[];for(var g=0,h=e.id.length;g<h;g++)j.push(hemi.world.getCitizenById(e.id[g]))}else j=hemi.world.getCitizenById(e.id);a[f]=j}else if(e.arg!==undefined){var k=a[f];k.apply(a,e.arg)}else alert("Unable to process octane for "+b.id+": missing property value")}},hemi}(hemi||{}),hemi=function(a){return a.handlers=a.handlers||{},a.handlers.ValueCheck=a.world.Citizen.extend({init:function(){this._super(),this.citizen=null,this.values=[],this.valueParams=[],this.handler=null,this.func=null,this.args=[]},citizenType:"hemi.handlers.ValueCheck",cleanup:function(){this._super(),this.citizen=null,this.values=[],this.handler=null,this.args=[]},handleMessage:function(b){var c=a.dispatch.getArguments(b,this.valueParams),d=!0;for(var e=0,f=c.length;d&&e<f;e++){var g=c[e];g!=null&&g.getId!==undefined?d=this.values[e]===g.getId():d=this.values[e]===g}if(d){var h=a.dispatch.getArguments(b,this.args);this.handler[this.func].apply(this.handler,h)}},toOctane:function(){var a=this._super(),b=["values","valueParams","func","args"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a.props.push({name:"handler",id:this.handler.getId()}),this.citizen&&a.props.push({name:"citizen",id:this.citizen.getId()}),a}}),a.handlers.handlePick=function(b,c,d,e,f){var g=new a.handlers.ValueCheck;return g.citizen=b,g.values=[c],g.valueParams=[a.dispatch.MSG_ARG+"data.pickInfo.shapeInfo.shape.name"],g.handler=d,g.func=e,f&&(g.args=f),a.world.subscribe(a.msg.pick,g,"handleMessage")},a.handlers.handleCameraMove=function(b,c,d,e,f){var g=new a.handlers.ValueCheck;return g.citizen=b,g.values=[c.getId()],g.valueParams=[a.dispatch.MSG_ARG+"data.viewpoint"],g.handler=d,g.func=e,f&&(g.args=f),b.subscribe(a.msg.stop,g,"handleMessage")},a}(hemi||{}),hemi=function(a){return a.audio=a.audio||{},a.audio.Audio=a.world.Citizen.extend({init:function(){this._super(),this.audio=document.createElement("audio"),this.looping=!1,this.seeking=!1,this.startPlay=!1,this.urls=[];var b=this;this.audio.addEventListener("emptied",function(c){b.send(a.msg.unload,{})},!0),this.audio.addEventListener("loadeddata",function(c){b.send(a.msg.load,{src:b.audio.currentSrc})},!0),this.audio.addEventListener("playing",function(c){b.send(a.msg.start,{})},!0),this.audio.addEventListener("ended",function(c){b.looping&&b.play(),b.send(a.msg.stop,{})},!0)},citizenType:"hemi.audio.Audio",addUrl:function(b,c){var d=document.createElement("source"),e=a.loader.getPath(b);d.setAttribute("src",e),d.setAttribute("type","audio/"+c),this.audio.appendChild(d),this.urls.push({url:b,type:c,node:d})},cleanup:function(){this._super(),this.audio=null,this.urls=[]},getDuration:function(){return this.audio?this.audio.duration:null},getVolume:function(){return this.audio?this.audio.volume:null},pause:function(){this.audio&&!this.audio.paused&&(this.audio.pause(),this.startPlay=!1)},play:function(){this.audio&&(this.seeking?this.startPlay=!0:(this.audio.paused||this.audio.ended)&&this.audio.play())},removeUrl:function(a){for(var b=0,c=this.urls.length;b<c;b++){var d=this.urls[b];if(d.url===a){this.audio.removeChild(d.node),this.urls.splice(b,1),d.node.src===this.audio.currentSrc&&this.audio.load();break}}},seek:function(a){if(this.audio&&a>=0&&a<this.audio.duration){var b=this,c=function(){b.audio.removeEventListener("seeked",c,!0),b.seeking=!1,b.startPlay&&(b.startPlay=!1,b.play())};this.audio.addEventListener("seeked",c,!0),this.seeking=!0,this.startPlay=!this.audio.paused,this.audio.currentTime=a}},setLoop:function(a){this.looping!==a&&(this.looping=a,!this.audio)},setLoop_:function(){this.looping?this.audio.setAttribute("loop","loop"):this.audio.removeAttribute("loop")},setVolume:function(a){this.audio&&(this.audio.volume=a)},toOctane:function(){var a=this._super();a.props.push({name:"looping",val:this.looping});for(var b=0,c=this.urls.length;b<c;b++){var d=this.urls[b];a.props.push({name:"addUrl",arg:[d.url,d.type]})}return a}}),a.audio.Audio.prototype.msgSent=a.audio.Audio.prototype.msgSent.concat([a.msg.load,a.msg.start,a.msg.stop,a.msg.unload]),a}(hemi||{}),hemi=function(a){a.dispatch=a.dispatch||{};var b=0;return a.dispatch.WILDCARD="*",a.dispatch.ID_ARG="id:",a.dispatch.MSG_ARG="msg:",a.dispatch.Message=function(){this.src=null,this.msg=null,this.data={}},a.dispatch.MessageSpec=function(){this.src=null,this.msg=null,this.targets=[]},a.dispatch.MessageSpec.prototype={cleanup:function(){for(var a=0,b=this.targets.length;a<b;a++)this.targets[a].cleanup();this.targets=[]},toOctane:function(){var b=[];for(var c=0,d=this.targets.length;c<d;c++){var e=this.targets[c].toOctane();e!==null?b.push(e):a.console.log("Null Octane returned by MessageTarget",a.console.ERR)}var f=[{name:"src",val:this.src},{name:"msg",val:this.msg},{name:"targets",oct:b}],g={type:"hemi.dispatch.MessageSpec",props:f};return g},addTarget:function(b){this.targets.indexOf(b)!=-1&&a.console.log("MessageSpec already contains MessageTarget",a.console.WARN),this.targets.push(b)},removeTarget:function(b){var c=null,d=this.targets.indexOf(b);if(d!=-1){var e=this.targets.splice(d,1);e.length===1&&(c=e[0])}else a.console.log("MessageTarget not found in MessageSpec",a.console.WARN);return c},getHash:function(){return this.msg+this.src}},a.dispatch.MessageTarget=function(){this.dispatchId=null,this.name="",this.handler=null,this.func=null,this.args=null},a.dispatch.MessageTarget.prototype={cleanup:function(){this.handler=null},toOctane:function(){if(!this.handler.getId)return a.console.log("Handler object in MessageTarget can not be saved to Octane",a.console.WARN),null;var b=["dispatchId","name","func","args"],c=[{name:"handler",id:this.handler.getId()}];for(var d=0,e=b.length;d<e;d++){var f=b[d];c.push({name:f,val:this[f]})}var g={type:"hemi.dispatch.MessageTarget",props:c};return g}},a.dispatch.msgSpecs=new a.utils.Hashtable,a.dispatch.setNextId=function(a){b=a},a.dispatch.getNextId=function(){return b++},a.dispatch.checkNextId=function(){return b},a.dispatch.loadEntries=function(a){for(var b=0,c=a.length;b<c;b++){var d=a[b];this.msgSpecs.put(d.getHash(),d)}},a.dispatch.cleanup=function(){this.msgSpecs.each(function(a,b){b.cleanup()}),this.msgSpecs.clear()},a.dispatch.toOctane=function(){var c={nextId:b,ents:[]};return this.msgSpecs.each(function(b,d){var e=d.toOctane();e!==null?c.ents.push(e):a.console.log("Null Octane returned by MessageSpec",a.console.ERR)}),c},a.dispatch.getSpecs=function(b,c){var d;if(b===undefined)d=this.msgSpecs.values();else{var e={};c?(b.src!==undefined&&(b.src===a.dispatch.WILDCARD?e.src=a.dispatch.WILDCARD:e.src=[b.src,a.dispatch.WILDCARD]),b.msg!==undefined&&(b.msg===a.dispatch.WILDCARD?e.msg=a.dispatch.WILDCARD:e.msg=[b.msg,a.dispatch.WILDCARD])):(b.src!==undefined&&(e.src=b.src),b.msg!==undefined&&(e.msg=b.msg)),d=this.msgSpecs.query(e)}return d},a.dispatch.getSpecsFast=function(b,c,d){var e=[],f=c+b,g=this.msgSpecs.get(f);g!==null&&e.push(g);if(d){var h=b===a.dispatch.WILDCARD;h||(f=c+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)),c!==a.dispatch.WILDCARD&&(f=a.dispatch.WILDCARD+b,g=this.msgSpecs.get(f),g!==null&&e.push(g),h||(f=a.dispatch.WILDCARD+a.dispatch.WILDCARD,g=this.msgSpecs.get(f),g!==null&&e.push(g)))}return e},a.dispatch.getTargets=function(a,b){var c=this.getSpecs(a,b),d=[],e,f,g;a!==undefined&&(e=a.dispatchId,f=a.name,g=a.handler);for(var h=0,i=c.length;h<i;h++){var j=c[h].targets;for(var k=0,l=j.length;k<l;k++){var m=j[k],n=!0;e!==undefined&&(n=m.dispatchId===e),n&&f!==undefined&&(n=m.name===f),n&&g!==undefined&&(n=m.handler===g),n&&d.push(m)}}return d},a.dispatch.getTargetSpec=function(a){var b=this.getSpecs(),c=a.dispatchId;for(var d=0,e=b.length;d<e;d++){var f=b[d],g=f.targets;for(var h=0,i=g.length;h<i;h++)if(g[h].dispatchId===c)return f}return null},a.dispatch.createSpec=function(b,c){var d=this.getSpecsFast(b,c,!1),e;return d.length===0?(e=new a.dispatch.MessageSpec,e.src=b,e.msg=c,this.msgSpecs.put(e.getHash(),e)):(d.length>1&&a.console.log("Found "+d.length+" MessageSpecs with the same src and msg.",a.console.ERR),e=d[0]),e},a.dispatch.registerTarget=function(b,c,d,e,f){var g=this.createSpec(b,c),h=new a.dispatch.MessageTarget;return h.dispatchId=this.getNextId(),h.handler=d,e&&(h.func=e),f&&(h.args=f),g.addTarget(h),h},a.dispatch.removeTarget=function(b,c){var d=this.getSpecs(c,!1),e=null;for(var f=0,g=d.length;f<g;f++){var h=d[f];e=h.removeTarget(b);if(e!==null)break}return e===null&&a.console.log("MessageTarget was not found and therefore not removed",a.console.WARN),e},a.dispatch.setTargetSpec=function(b,c,d){var e=this.getTargetSpec(b);e!==null?e.removeTarget(b):a.console.log("Previous MessageSpec for MessageTarget not found",a.console.WARN),e=this.createSpec(c,d),e.addTarget(b)},a.dispatch.postMessage=function(b,c,d){var e=new a.dispatch.Message,f=b.getId();e.src=b,e.msg=c,e.data=d;var g=this.getSpecsFast(f,c,!0);for(var h=0,i=g.length;h<i;h++){var j=g[h].targets.slice(0);for(var k=0,l=j.length;k<l;k++){var m=j[k],n,o;m.args!==null?n=this.getArguments(e,m.args):n=[e],m.func?o=m.handler[m.func]:o=m.handler,o.apply(m.handler,n)}}},a.dispatch.getArguments=function(b,c){var d=[];for(var e=0,f=c.length;e<f;e++){var g=c[e];if(typeof g!="string")d[e]=g;else if(g.substring(0,3)===a.dispatch.ID_ARG){var h=parseInt(g.substring(3));d.push(a.world.getCitizenById(h))}else if(g.substring(0,4)===a.dispatch.MSG_ARG){g=g.substring(4);var i=g.split("."),j=b;for(aNdx=0,aLen=i.length;j!=null&&aNdx<aLen;aNdx++)j=j[i[aNdx]];d.push(j)}else d[e]=g}return d},a}(hemi||{}),hemi=function(a){a.input=a.input||{},a.input.init=function(){a.input.mouseDownListeners=[],a.input.mouseUpListeners=[],a.input.mouseMoveListeners=[],a.input.mouseWheelListeners=[],a.input.keyDownListeners=[],a.input.keyUpListeners=[],a.input.keyPressListeners=[],a.core.event.addEventListener(a.core.o3dElement,"mousedown",a.input.mouseDown),a.core.event.addEventListener(a.core.o3dElement,"mousemove",a.input.mouseMove),a.core.event.addEventListener(a.core.o3dElement,"mouseup",a.input.mouseUp),a.core.event.addEventListener(a.core.o3dElement,"wheel",a.input.scroll),document.addEventListener("keypress",function(b){a.input.keyPress(b)},!0),document.addEventListener("keydown",function(b){a.input.keyDown(b)},!0),document.addEventListener("keyup",function(b){a.input.keyUp(b)},!0)},a.input.addMouseDownListener=function(c){b(a.input.mouseDownListeners,c)},a.input.addMouseUpListener=function(c){b(a.input.mouseUpListeners,c)},a.input.addMouseMoveListener=function(c){b(a.input.mouseMoveListeners,c)},a.input.addMouseWheelListener=function(c){b(a.input.mouseWheelListeners,c)},a.input.addKeyDownListener=function(c){b(a.input.keyDownListeners,c)},a.input.addKeyUpListener=function(c){b(a.input.keyUpListeners,c)},a.input.addKeyPressListener=function(c){b(a.input.keyPressListeners,c)},a.input.removeMouseDownListener=function(b){return c(a.input.mouseDownListeners,b)},a.input.removeMouseUpListener=function(b){return c(a.input.mouseUpListeners,b)},a.input.removeMouseMoveListener=function(b){return c(a.input.mouseMoveListeners,b)},a.input.removeMouseWheelListener=function(b){return c(a.input.mouseWheelListeners,b)},a.input.removeKeyDownListener=function(b){return c(a.input.keyDownListeners,b)},a.input.removeKeyUpListener=function(b){return c(a.input.keyUpListeners,b)},a.input.removeKeyPressListener=function(b){return c(a.input.keyPressListeners,b)},a.input.mouseDown=function(b){for(var c=0;c<a.input.mouseDownListeners.length;c++)a.input.mouseDownListeners[c].onMouseDown(b)},a.input.mouseUp=function(b){for(var c=0;c<a.input.mouseUpListeners.length;c++)a.input.mouseUpListeners[c].onMouseUp(b)},a.input.mouseMove=function(b){for(var c=0;c<a.input.mouseMoveListeners.length;c++)a.input.mouseMoveListeners[c].onMouseMove(b)},a.input.scroll=function(b){for(var c=0;c<a.input.mouseWheelListeners.length;c++)a.input.mouseWheelListeners[c].onScroll(b)},a.input.keyDown=function(b){for(var c=0;c<a.input.keyDownListeners.length;c++)a.input.keyDownListeners[c].onKeyDown(b)},a.input.keyUp=function(b){for(var c=0;c<a.input.keyUpListeners.length;c++)a.input.keyUpListeners[c].onKeyUp(b)},a.input.keyPress=function(b){for(var c=0;c<a.input.keyPressListeners.length;c++)a.input.keyPressListeners[c].onKeyPress(b)};var b=function(a,b){a.push(b)},c=function(a,b){var c=null,d=a.indexOf(b);if(d!=-1){var e=a.splice(d,1);e.length==1&&(c=e[0])}return c};return a}(hemi||{}),hemi=function(a){return a.view=a.view||{},a.view.defaults={MOUSE_SPEED:.005,MOUSE_DELTA:.0015,TRUCK_SPEED:.02,FOV:.707107,NP:1,FP:1e4,MOVE_TIME:72,MIN_FOV:.05,MAX_FOV:Math.PI/3,MIN_TILT:-Math.PI/2.001,MAX_TILT:Math.PI/2.001},a.view.projection={PERSPECTIVE:0,XY:1,XZ:2,YZ:3},a.view.Camera=a.world.Citizen.extend({init:function(){this._super();var b=a.utils.penner.linearTween,c={cam:a.core.mainPack.createObject("Transform"),pan:a.core.mainPack.createObject("Transform"),tilt:a.core.mainPack.createObject("Transform"),target:a.core.mainPack.createObject("Transform")};c.cam.name="hemi.view.cam",c.pan.name="hemi.view.pan",c.tilt.name="hemi.view.tilt",c.target.name="hemi.view.target",c.pan.parent=a.core.client.root,c.tilt.parent=c.pan,c.cam.parent=c.tilt,c.target.parent=c.cam,c.target.translate([0,0,-1]),c.cam.translate([0,0,1]),this.transforms=c,this.vd={current:null,last:null},this.paramObj=a.core.mainPack.createObject("ParamObject"),this.light={position:this.paramObj.createParam("lightWorldPos","ParamFloat3"),color:this.paramObj.createParam("lightColor","ParamFloat4"),fixed:!0},this.light.color.value=[1,1,1,1],this.pan={current:0,min:null,max:null},this.tilt={current:0,min:a.view.defaults.MIN_TILT,max:a.view.defaults.MAX_TILT},this.fov={current:a.view.defaults.FOV,min:a.view.defaults.MIN_FOV,max:a.view.defaults.MAX_FOV},this.camPan={current:0,min:null,max:null},this.camTilt={current:0,min:null,max:null},this.distance=1,this.up=[0,1,0],this.mode={scroll:!0,scan:!0,fixed:!1,frames:!0,control:!1,projection:a.view.projection.PERSPECTIVE},this.state={moving:!1,curve:null,time:{current:0,end:0},mouse:!1,xy:{current:[-1,-1],last:[-1,-1]},shift:!1,update:!1,vp:null},this.clip={near:a.view.defaults.NP,far:a.view.defaults.FP},this.easeFunc=[b,b,b],a.view.addRenderListener(this),this.update(),this.updateProjection()},citizenType:"hemi.view.Camera",clampPanTilt:function(){var a=this.camPan,b=this.camTilt;a.current=a.min!=null&&a.current<=a.min?a.min:a.max!=null&&a.current>=a.max?a.max:a.current,b.current=b.min!=null&&b.current<=b.min?b.min:b.max!=null&&b.current>=b.max?b.max:b.current},cleanup:function(){a.view.removeRenderListener(this),this._super(),this.disableControl();for(t in this.transforms)this.transforms[t].parent=null,a.core.mainPack.removeObject(this.transforms[t]),this.transforms[t]=null;this.paramObj.removeParam(this.light.position),this.paramObj.removeParam(this.light.color),a.core.mainPack.removeObject(this.paramObj),this.paramObj=null,this.light.position=null,this.light.color=null},disableControl:function(){return this.mode.control?(a.input.removeMouseDownListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseMoveListener(this),a.input.removeMouseWheelListener(this),a.input.removeKeyDownListener(this),a.input.removeKeyUpListener(this),this.mode.control=!1,this.state.mouse=!1,!0):!1},disableScan:function(){this.mode.scan=!1},disableZoom:function(){this.mode.scroll=!1},enableControl:function(){return this.mode.control?!1:(a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this),a.input.addMouseWheelListener(this),a.input.addKeyDownListener(this),a.input.addKeyUpListener(this),this.mode.control=!0,!0)},enableScan:function(){this.mode.scan=!0},enableZoom:function(){this.mode.scroll=!0},fixEye:function(){return this.mode.fixed=!0,this.update(),this},lightOnCam:function(){return this.light.fixed=!0,this.update(),this},freeEye:function(){return this.mode.fixed=!1,this.mode.projection||(this.transforms.cam.identity(),this.transforms.cam.translate([0,0,this.distance])),this.update(),this},lightAtPosition:function(a){return this.light.position.value=a,this.light.fixed=!1,this.update(),this},getEye:function(){return this.transforms.cam.getUpdatedWorldMatrix()[3].slice(0,3)},getTarget:function(){return this.mode.fixed?this.transforms.target.getUpdatedWorldMatrix()[3].slice(0,3):this.transforms.pan.getUpdatedWorldMatrix()[3].slice(0,3)},moveInFrames:function(){this.mode.frames=!0},moveInSeconds:function(){this.mode.frames=!1},moveOnCurve:function(b,c){this.vd.current!==null?this.vd.last=this.vd.current:this.vd.last=a.view.createViewData(this),this.vd.current=new a.view.ViewData({eye:b.eye.getEnd(),target:b.target.getEnd(),up:this.up,fov:this.fov.current,np:this.clip.near,fp:this.clip.far}),this.state.curve=b,this.state.moving=!0,this.state.vp=null,this.state.time.end=c==null?1:c>0?c:.001,this.state.time.current=0,this.send(a.msg.start,{viewdata:this.vd.current})},moveOrthographic:function(b,c){var d=b*2*this.distance/a.core.client.width,e=c*2*this.distance/a.core.client.width;switch(this.mode.projection){case a.view.projection.XY:case a.view.projection.YZ:this.transforms.pan.translate([-d,e,0]);break;case a.view.projection.XZ:this.transforms.pan.translate([d,0,e])}},movePerspective:function(b,c){if(this.state.shift&&this.mode.scan){var d=a.view.defaults.MOUSE_DELTA*this.distance*b,e=a.view.defaults.MOUSE_DELTA*this.distance*c;this.transforms.pan.translate([-d,e*Math.cos(this.tilt.current),e*Math.sin(this.tilt.current)]),this.update()}else this.mode.fixed?this.rotate(-b*a.view.defaults.MOUSE_SPEED,-c*a.view.defaults.MOUSE_SPEED):this.orbit(-b*a.view.defaults.MOUSE_SPEED,-c*a.view.defaults.MOUSE_SPEED)},moveToView:function(b,c){var d=c==null?1:c,e;b.getData!=null?(this.vd.current=b.getData(),this.state.vp=b,e={viewpoint:b}):(this.vd.current=b,this.state.vp=null,e={viewdata:b}),this.vd.last=a.view.createViewData(this),this.state.curve=null,this.state.time.end=d>0?d:.001,this.state.time.current=0,this.state.moving=!0,this.send(a.msg.start,e)},onKeyDown:function(a){this.state.shift=a.keyCode==16},onKeyUp:function(a){a.keyCode==16&&(this.state.shift=!1)},onMouseDown:function(a){this.state.mouse=!0,this.state.xy.current[0]=this.state.xy.last[0]=a.x,this.state.xy.current[1]=this.state.xy.last[1]=a.y},onMouseMove:function(a){if(this.state.mouse){this.state.xy.last[0]=this.state.xy.current[0],this.state.xy.last[1]=this.state.xy.current[1],this.state.xy.current[0]=a.x,this.state.xy.current[1]=a.y;var b=this.state.xy.current[0]-this.state.xy.last[0],c=this.state.xy.current[1]-this.state.xy.last[1];this.mode.projection?this.moveOrthographic(b,c):this.movePerspective(b,c)}},onMouseUp:function(a){this.state.mouse=!1},onRender:function(a){var b=this.state,c=b.xy;(b.mouse&&(c.current[0]!==c.last[0]||c.current[1]!==c.last[1])||b.moving||b.update)&&this.update(a.elapsedTime),b.update=!1},onScroll:function(b){if(!this.mode.scroll)return;if(this.state.shift){var c=this.distance*a.view.defaults.TRUCK_SPEED,d=b.deltaY>0?1:-1;this.truck(c*d)}else{if(this.mode.fixed){var e=(this.fov.max+this.fov.min)/2;b.deltaY>0?this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*11/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*13/12:this.fov.current<e?this.fov.current=this.fov.min+(this.fov.current-this.fov.min)*13/12:this.fov.current=this.fov.max-(this.fov.max-this.fov.current)*11/12,this.updateProjection(),this.state.update=!0;return}var f=b.deltaY>0?11/12:13/12;this.distance=a.core.math.lerpScalar(0,this.distance,f),this.mode.projection||(this.transforms.cam.identity(),this.transforms.cam.translate([0,0,this.distance])),this.updateProjection(),this.state.update=!0}},orbit:function(a,b){b==null&&(b=0);var c=this.tilt.current;this.pan.current+=a,this.tilt.current+=b,this.tilt.current>=this.tilt.max?this.tilt.current=this.tilt.max:this.tilt.current<=this.tilt.min&&(this.tilt.current=this.tilt.min),this.transforms.pan.rotateY(a),this.transforms.tilt.rotateX(this.tilt.current-c),this.update()},rotate:function(a,b){var c=this.transforms.cam;b==null&&(b=0),this.camPan.current+=a,this.camTilt.current+=b,this.clampPanTilt(),c.identity(),c.translate([0,0,this.distance]),c.rotateY(this.camPan.current),c.rotateX(this.camTilt.current),this.update()},setLookAroundLimits:function(a,b,c,d){return this.camPan.min=a,this.camPan.max=b,this.camTilt.min=c,this.camTilt.max=d,this},setEasing:function(a){return typeof a=="function"?this.easeFunc=[a,a,a]:this.easeFunc=[a.x||this.easeFunc[0],a.y||this.easeFunc[1],a.z||this.easeFunc[2]],this},setEyeTarget:function(b,c){var d=[b[0]-c[0],b[1]-c[1],b[2]-c[2]],e=a.utils.cartesianToSpherical(d),f=this.transforms;this.distance=e[0],this.tilt.current=e[1]-Math.PI/2,this.pan.current=e[2],f.pan.identity(),f.pan.translate(c),f.pan.rotateY(this.pan.current),f.tilt.identity(),f.tilt.rotateX(this.tilt.current);var g=[0,0,this.distance];f.cam.identity(),f.cam.translate(g),a.utils.pointZAt(f.cam,g,a.utils.pointAsLocal(f.cam,c)),f.cam.rotateY(Math.PI),this.camPan.current=0,this.camTilt.current=0},setLight:function(a){return this.light.color.value=[a[0],a[1],a[2],1],this},setOrthographic:function(a){this.mode.projection=a,this.updateProjection()},setPerspective:function(){this.mode.projection=0,this.updateProjection()},setZoomLimits:function(a,b){this.fov.min=a,this.fov.max=b,this.fov.current>this.fov.max&&(this.fov.current=this.fov.max),this.fov.current<this.fov.min&&(this.fov.current=this.fov.min)},toOctane:function(){var b=this._super(),c=a.view.createViewData(this);return b.props.push({name:this.mode.control?"enableControl":"disableControl",arg:[]}),b.props.push({name:"mode",val:this.mode}),b.props.push({name:"moveToView",arg:[c,0]}),b},truck:function(a){this.transforms.pan.rotateX(this.tilt.current),this.transforms.pan.translate(0,0,-a),this.transforms.pan.rotateX(-this.tilt.current),this.update()},interpolateView:function(a,b){var c=[],d=[],e=this.vd.last,f=this.vd.current,g=!1;if(this.state.curve){var h=this.easeFunc[0](a,0,1,b);c=this.state.curve.eye.interpolate(h),d=this.state.curve.target.interpolate(h)}else for(var i=0;i<3;i++)c[i]=this.easeFunc[i](a,e.eye[i],f.eye[i]-e.eye[i],b),d[i]=this.easeFunc[i](a,e.target[i],f.target[i]-e.target[i],b);f.fov!==e.fov&&(this.fov.current=this.easeFunc[0](a,e.fov,f.fov-e.fov,b),g=!0),f.np!==e.np&&(this.clip.near=this.easeFunc[0](a,e.np,f.np-e.np,b),g=!0),f.fp!==e.fp&&(this.clip.far=this.easeFunc[0](a,e.fp,f.fp-e.fp,b),g=!0),g&&this.updateProjection(),this.setEyeTarget(c,d)},update:function(b){var c=this.state.time;if(this.state.moving){this.interpolateView(c.current,c.end);if(b!=undefined){var d=this.mode.frames?1/a.view.FPS:b;c.current>=c.end&&(this.state.moving=!1,this.state.curve=null,this.state.vp!==null?(this.send(a.msg.stop,{viewpoint:this.state.vp}),this.state.vp=null):this.send(a.msg.stop,{viewdata:this.vd.current})),c.current+=d,c.current>=c.end&&(c.current=c.end)}}this.transforms.target.identity(),this.transforms.target.translate([0,0,-this.distance]),a.view.viewInfo.drawContext.view=a.core.math.matrix4.lookAt(this.getEye(),this.getTarget(),this.up),this.light.fixed&&(this.light.position.value=this.getEye())},updateProjection:function(){var b=a.view.clientSize.width/a.view.clientSize.height;if(this.mode.projection){var c=this.distance;a.view.viewInfo.drawContext.projection=a.core.math.matrix4.orthographic(-c,c,-c/b,c/b,0,this.clip.far)}else a.view.viewInfo.drawContext.projection=a.core.math.matrix4.perspective(this.fov.current,b,this.clip.near,this.clip.far)}}),a.view.Camera.prototype.msgSent=a.view.Camera.prototype.msgSent.concat([a.msg.start,a.msg.stop]),a.view.CameraCurve=a.world.Citizen.extend({init:function(a,b){this._super(),this.eye=a,this.target=b},citizenType:"hemi.view.CameraCurve",cleanup:function(){this._super(),this.eye=null,this.target=null},toOctane:function(){var a=this._super();return a.props.push({name:"eye",oct:this.eye.toOctane()}),a.props.push({name:"target",oct:this.target.toOctane()}),a}}),a.view.ViewData=function(b){var c=b||{};this.eye=c.eye||[0,0,-1],this.target=c.target||[0,0,0],this.up=c.up||[0,1,0],this.fov=c.fov||a.view.defaults.FOV,this.np=c.np||a.view.defaults.NP,this.fp=c.fp||a.view.defaults.FP},a.view.Viewpoint=a.world.Citizen.extend({init:function(b){this._super();var c=b||{};this.name=c.name||"",this.eye=c.eye||[0,0,-1],this.target=c.target||[0,0,0],this.up=c.up||[0,1,0],this.fov=c.fov||a.view.defaults.FOV,this.np=c.np||a.view.defaults.NP,this.fp=c.fp||a.view.defaults.FP},citizenType:"hemi.view.Viewpoint",getData:function(){return new a.view.ViewData(this)},setData:function(a){this.eye=a.eye,this.target=a.target,this.up=a.up,this.fov=a.fov,this.np=a.np,this.fp=a.fp},toOctane:function(){var a=this._super(),b=["eye","target","up","fov","np","fp"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a}}),a.view.ClientSize=function(){this.width=0,this.height=0},a.view.ClientSize.prototype.onRender=function(){var b=parseInt(a.core.client.width),c=parseInt(a.core.client.height);(b!=this.width||c!=this.height)&&a.world.camera!=null&&(this.width=b,this.height=c,a.world.camera.updateProjection())},a.view.init=function(){this.FPS=24,this.defaultBG=[1,1,1,1],this.clientSize=new a.view.ClientSize,this.renderListeners=[],this.viewInfo=a.core.renderGraph.createBasicView(a.core.mainPack,a.core.client.root,a.core.client.renderGraphRoot),this.setBGColor(this.defaultBG),a.view.addRenderListener(this.clientSize),a.core.client.setRenderCallback(a.view.onRender)},a.view.addRenderListener=function(b){var c=a.view.renderListeners.indexOf(b);c===-1&&a.view.renderListeners.push(b)},a.view.removeRenderListener=function(b){var c=a.view.renderListeners.indexOf(b),d=null;return c!==-1&&(d=a.view.renderListeners.splice(c,1)),d},a.view.onRender=function(b){for(var c=0;c<a.view.renderListeners.length;c++)a.view.renderListeners[c].onRender(b)},a.view.setBGColor=function(a){this.viewInfo.clearBuffer.clearColor=a},a.view.getBGColor=function(){return this.viewInfo.clearBuffer.clearColor},a.view.getTimeOfFrame=function(a){return a/this.FPS},a.view.createViewData=function(b){return new a.view.ViewData({eye:b.getEye(),target:b.getTarget(),up:b.up,fov:b.fov.current,np:b.clip.near,fp:b.clip.far})},a.view.createViewpoint=function(b,c){var d=new a.view.Viewpoint({name:b});return d.setData(this.createViewData(c)),d},a.view.createCustomViewpoint=function(b,c,d,e,f,g,h){var i=new a.view.Viewpoint({name:b,eye:c,target:d,up:e,fov:f,np:g,fp:h});return i},a}(hemi||{}),hemi=function(a){a.model=a.model||{},a.model.MODEL_ROOT="ModelRoot",a.model.TransformUpdate=function(){this.localMatrix=null,this.visible=null,this.pickable=null,this.opacity=null,this.transform=null,this.toLoad=null},a.model.TransformUpdate.prototype={toOctane:function(){var a={type:"hemi.model.TransformUpdate",props:[{name:"toLoad",val:this.transform.name}]},b=["localMatrix","visible","pickable","opacity"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a},isModified:function(){return this.localMatrix!=null||this.pickable!=null||this.visible!=null||this.opacity!=null},apply:function(b){if(this.toLoad!==null){var c=b.getTransforms(this.toLoad);if(c.length===1)this.transform=c[0],this.toLoad=null;else{a.console.log(c.length+" transforms with name "+this.toLoad+" in model "+b.name,a.console.ERR);return}}this.localMatrix!=null&&(this.transform.localMatrix=this.localMatrix),this.pickable!=null&&a.picking.setPickable(this.transform,this.pickable,!0),this.visible!=null&&(this.transform.visible=this.visible),this.opacity!=null&&b.setTransformOpacity(this.transform,this.opacity,!1)}},a.model.ModelConfig=function(){this.pack=a.core.client.createPack(),this.rootTransform=this.pack.createObject("Transform"),this.rootTransform.parent=a.model.modelRoot;var b=this.pack.createObject("ParamObject");this.animationTime=b.createParam("animTime","ParamFloat")},a.model.ModelConfig.prototype={getMaterials:function(){return this.pack.getObjectsByClassName("o3d.Material")},getShapes:function(){return this.pack.getObjectsByClassName("o3d.Shape")},getTransforms:function(){return this.pack.getObjectsByClassName("o3d.Transform")},isSkinned:function(){return this.pack.getObjectsByClassName("o3d.Skin").length>0}},a.model.Model=a.world.Citizen.extend({init:function(){this._super(),this.isAnimating=!1,this.isSkinned=!1,this.fileName="",this.root=null,this.materials=[],this.shapes=[],this.transforms=[],this.transformUpdates=[],this.animParam=null,this.pack=null},citizenType:"hemi.model.Model",cleanup:function(){this._super(),this.unload()},toOctane:function(){var a=this._super();a.props.push({name:"setFileName",arg:[this.fileName]});var b={name:"transformUpdates",oct:[]};for(var c=0,d=this.transformUpdates.length;c<d;c++){var e=this.transformUpdates[c];e.isModified()&&b.oct.push(e.toOctane())}return a.props.push(b),a},setFileName:function(a,c){this.fileName=a,this.name.length<=0&&(this.name=b(a)),this.load(c)},load:function(b){var c=new a.model.ModelConfig,d=this;this.pack!==null&&this.unload(),a.loader.loadModel(this.fileName,c.pack,c.rootTransform,function(b,e){a.core.loaderCallback(b),d.loadConfig(c)},{opt_animSource:c.animationTime},b)},loadConfig:function(c){var d=this.getId();this.name.length<=0&&(this.name=b(this.fileName)),this.isSkinned=c.isSkinned(),this.root=c.rootTransform,this.root.name=this.name+"_Root",this.isSkinned?(a.view.viewInfo.renderGraphRoot.render(),this.root.recalculateBoundingBox(!0,!0)):this.root.recalculateBoundingBox(!0),this.animParam=c.animationTime,this.materials=c.getMaterials(),this.shapes=c.getShapes(),this.transforms=c.getTransforms(),this.pack=c.pack;for(var e=0,f=this.materials.length;e<f;++e){var g=this.materials[e],h=g.createParam("ownerId","o3d.ParamInteger");h.value=d}for(var i=0,j=this.transforms.length;i<j;++i){var k=this.transforms[i],h=k.createParam("ownerId","o3d.ParamInteger");h.value=d}for(var i=0,j=this.transformUpdates.length;i<j;i++){var l=this.transformUpdates[i];l.apply(this)}a.world.tranReg.distribute(this),this.send(a.msg.load,{})},getAnimationParameter:function(){return this.animParam},getAnimationTime:function(){var a=0;return this.animParam&&(a=this.animParam.value),a},getMaxAnimationTime:function(){var a=this.pack.getObjectsByClassName("o3d.Curve"),b=0;for(var c=0;c<a.length;c++){var d=a[c].keys;for(var e=0;e<d.length;e++){var f=d[e].input;b=f>b?f:b}}return b},incrementAnimationTime:function(a){this.animParam&&this.setAnimationTime(this.animParam.value+a)},setAnimationTime:function(b){if(this.animParam){var c=this.animParam.value;this.animParam.value=b,this.send(a.msg.animate,{previous:c,time:b})}},getMaterials:function(a){var b=[];for(var c=0,d=this.materials.length;c<d;c++){var e=this.materials[c];e.name===a&&b.push(e)}return b},getShapes:function(a){var b=[];for(var c=0,d=this.shapes.length;c<d;c++){var e=this.shapes[c];e.name===a&&b.push(e)}return b},getTransforms:function(a){var b=[];for(var c=0,d=this.transforms.length;c<d;c++){var e=this.transforms[c];e.name===a&&b.push(e)}return b},getTransformUpdate:function(b){var c=null;for(var d=0,e=this.transformUpdates.length;d<e;d++){var f=this.transformUpdates[d];if(f.transform===b){c=f;break}}return c===null&&(c=new a.model.TransformUpdate,c.transform=b,this.transformUpdates.push(c)),c},getCenterPoint:function(){var a=this.root.boundingBox,b=a.maxExtent[0]-a.minExtent[0],c=a.maxExtent[1]-a.minExtent[1],d=a.maxExtent[2]-a.minExtent[2],e=[b/2,c/2,d/2];return e},getBoundingBox:function(){return this.root.boundingBox},setPickable:function(a){var b=a.pick,c;a.transforms instanceof Array?c=a.transforms:c=[a.transforms];for(var d=0,e=c.length;d<e;d++)this.setTransformPickable(c[d],b)},setTransformOpacity:function(b,c,d){var e=this.getTransformUpdate(b),f=b.shapes,g=b.getParam("opacity"),h=d==null?!0:d;if(g==null){for(var i=0,j=f.length;i<j;i++){var k=f[i],l=k.elements;for(var m=0,n=l.length;m<n;m++)a.fx.addOpacity(l[m].material)}g=b.createParam("opacity","ParamFloat")}g.value=c,e.opacity=c===1?null:c;if(h){var o=b.children;for(var i=0,j=o.length;i<j;i++)this.setTransformOpacity(o[i],c,!0)}},setTransformPickable:function(b,c){var d=this.getTransformUpdate(b);a.picking.setPickable(b,c,!0),d.pickable=c?null:!1},setTransformVisible:function(a,b){var c=this.getTransformUpdate(a);a.visible=b,c.visible=b?null:!1},setVisible:function(a){var b=a.vis,c;a.transforms instanceof Array?c=a.transforms:c=[a.transforms];for(var d=0,e=c.length;d<e;d++)this.setTransformVisible(c[d],b)},rotate:function(a){var b=a.axis.toLowerCase(),c=a.rad,d;a.transforms instanceof Array?d=a.transforms:d=[a.transforms];for(var e=0,f=d.length;e<f;e++)switch(b){case"x":this.rotateTransformX(d[e],c);break;case"y":this.rotateTransformY(d[e],c);break;case"z":this.rotateTransformZ(d[e],c)}},rotateTransformX:function(b,c){var d=this.getTransformUpdate(b);b.rotateX(c),d.localMatrix=a.utils.clone(b.localMatrix)},rotateTransformY:function(b,c){var d=this.getTransformUpdate(b);b.rotateY(c),d.localMatrix=a.utils.clone(b.localMatrix)},rotateTransformZ:function(b,c){var d=this.getTransformUpdate(b);b.rotateZ(c),d.localMatrix=a.utils.clone(b.localMatrix)},scale:function(a){var b=a.x,c=a.y,d=a.z,e;a.transforms instanceof Array?e=a.transforms:e=[a.transforms];for(var f=0,g=e.length;f<g;f++)this.scaleTransform(e[f],b,c,d)},scaleTransform:function(b,c,d,e){if(c<0||d<0||e<0)throw"Cannot scale with a negative number";var f=this.getTransformUpdate(b);b.scale(c,d,e),f.localMatrix=a.utils.clone(b.localMatrix)},setTransformMatrix:function(b,c){var d=this.getTransformUpdate(b);b.localMatrix=c,d.localMatrix=a.utils.clone(b.localMatrix)},unload:function(){this.materials=[],this.shapes=[],this.transforms=[],this.transformUpdates=[],this.pack!==null&&(this.root.parent=null,this.pack.destroy(),this.pack=null,this.root=null,this.animParam=null),this.send(a.msg.unload,{})}}),a.model.Model.prototype.msgSent=a.model.Model.prototype.msgSent.concat([a.msg.animate,a.msg.load,a.msg.unload]),a.model.init=function(){this.modelRoot=a.core.mainPack.createObject("Transform"),this.modelRoot.name=a.model.MODEL_ROOT,this.modelRoot.parent=a.picking.pickRoot};var b=function(a){var b=a.lastIndexOf("/");b<1&&(b=a.length);var c=a.lastIndexOf("/",b-1)+1;return c>=b&&(c=0),a.substring(c,b)};return a}(hemi||{}),hemi=function(a){return a.animation=a.animation||{},a.animation.Loop=function(){this.name="",this.startTime=0,this.stopTime=0,this.iterations=-1,this.current=0},a.animation.Loop.prototype={toOctane:function(){var a={type:"hemi.animation.Loop",props:[{name:"startTime",val:this.startTime},{name:"stopTime",val:this.stopTime},{name:"iterations",val:this.iterations},{name:"name",val:this.name}]};return a}},a.animation.Animation=a.world.Citizen.extend({init:function(){this._super(),this.target=null,this.beginTime=0,this.endTime=0,this.currentTime=0,this.loops=[]},citizenType:"hemi.animation.Animation",cleanup:function(){this.target.isAnimating&&this.stop(),this._super(),this.target=null,this.loops=[]},toOctane:function(){var a=this._super();a.props.push({name:"target",id:this.target.getId()}),a.props.push({name:"beginTime",val:this.beginTime}),a.props.push({name:"endTime",val:this.endTime}),a.props.push({name:"currentTime",val:this.beginTime});var b={name:"loops",oct:[]};for(var c=0,d=this.loops.length;c<d;c++)b.oct.push(this.loops[c].toOctane());return a.props.push(b),a},addLoop:function(a){this.loops.push(a)},removeLoop:function(a){var b=null,c=this.loops.indexOf(a);if(c!=-1){var d=this.loops.splice(c,1);d.length==1&&(b=d[0])}return b},checkLoops:function(){for(var a=0;a<this.loops.length;a++){var b=this.loops[a];b.current!=b.iterations&&this.currentTime>=b.stopTime&&(this.currentTime=b.startTime,b.current++)}},reset:function(){this.currentTime=this.beginTime;for(var a=0;a<this.loops.length;a++)this.loops[a].current=0},start:function(){this.target.isAnimating||(this.target.isAnimating=!0,this.updateTarget(this.currentTime),a.view.addRenderListener(this),this.send(a.msg.start,{}))},stop:function(){var b=a.view.removeRenderListener(this);this.target.isAnimating=!1,this.send(a.msg.stop,{})},onRender:function(a){this.currentTime+=a.elapsedTime,this.checkLoops(),this.currentTime<this.endTime?this.updateTarget(this.currentTime):(this.updateTarget(this.endTime),this.stop(),this.reset())},updateTarget:function(a){this.target.setAnimationTime(a)}}),a.animation.Animation.prototype.msgSent=a.animation.Animation.prototype.msgSent.concat([a.msg.start,a.msg.stop]),a.animation.createModelAnimation=function(b,c,d){var e=new a.animation.Animation;return e.target=b,e.beginTime=c,e.currentTime=c,e.endTime=d,e},a}(hemi||{}),hemi=function(a){a.motion=a.motion||{},a.motion.Rotator=a.world.Citizen.extend({init:function(b,c){this._super();var d=c||{};this.accel=d.accel||[0,0,0],this.angle=d.angle||[0,0,0],this.origin=d.origin||[0,0,0],this.vel=d.vel||[0,0,0],this.offset=a.core.math.mulScalarVector(-1,this.origin),this.time=0,this.stopTime=0,this.steadyRotate=!1,this.mustComplete=!1,this.startAngle=this.angle,this.stopAngle=this.angle,this.toLoad={},this.transformObjs=[],b!=null&&this.addTransform(b),this.enable()},addTransform:function(b){a.world.tranReg.register(b,this);var d=b.getParam("ownerId"),e={},f=null,g=null;d!==null&&(f=d.value,g=a.world.getCitizenById(f));if(a.utils.isAnimated(b)){var h=a.core.mainPack.createObject("Transform"),i=a.utils.fosterTransform(b);h.name=b.name+" Rotator",i.name=b.name+" Offset",d=h.createParam("ownerId","o3d.ParamInteger"),d.value=f,d=i.createParam("ownerId","o3d.ParamInteger"),d.value=f,h.parent=b,i.parent=h,e.rotTran=h,e.offTran=i,e.parent=b,e.foster=!0}else{var h=a.core.mainPack.createObject("Transform"),i=a.core.mainPack.createObject("Transform");h.name=b.name+" Rotator",i.name=b.name+" Offset",d=h.createParam("ownerId","o3d.ParamInteger"),d.value=f,d=i.createParam("ownerId","o3d.ParamInteger"),d.value=f,h.parent=b.parent,i.parent=h,b.parent=i,h.localMatrix=a.utils.clone(b.localMatrix),b.identity(),e.rotTran=i,e.offTran=b,e.parent=h,e.foster=!1}if(g){var j=this;e.owner=g,e.msg=g.subscribe(a.msg.cleanup,function(a){j.removeTransforms(a.src)})}this.transformObjs.push(e),c.call(this,[e])},citizenType:"hemi.motion.Rotator",cleanup:function(){this.disable(),this._super(),this.clearTransforms()},clear:function(){this.accel=[0,0,0],this.angle=[0,0,0],this.offset=[0,0,0],this.origin=[0,0,0],this.vel=[0,0,0]},clearTransforms:function(){while(this.transformObjs.length>0)b.call(this,this.transformObjs[0])},disable:function(){this.enabled&&(a.view.removeRenderListener(this),this.enabled=!1)},enable:function(){this.enabled=!0,d.call(this)},getTransforms:function(){var a=[];for(var b=0,c=this.transformObjs.length;b<c;b++){var d=this.transformObjs[b];d.foster?a.push(d.rotTran.parent):a.push(d.offTran)}return a},rotate:function(b,c,d){return!this.enabled||this.mustComplete?!1:(this.time=0,this.stopTime=c||.001,this.steadyRotate=!0,this.startAngle=this.angle,this.mustComplete=d||!1,this.stopAngle=a.core.math.addVector(this.angle,b),a.view.addRenderListener(this),this.send(a.msg.start,{}),!0)},onRender:function(b){if(this.transformObjs.length>0){var d=b.elapsedTime;if(this.steadyRotate){this.time+=d,this.time>=this.stopTime&&(this.time=this.stopTime,this.steadyRotate=this.mustComplete=!1,a.view.removeRenderListener(this),this.send(a.msg.stop,{}));var e=this.time/this.stopTime;this.angle=a.core.math.lerpVector(this.startAngle,this.stopAngle,e)}else this.vel=a.core.math.addVector(this.vel,a.core.math.mulScalarVector(d,this.accel)),this.angle=a.core.math.addVector(this.angle,a.core.math.mulScalarVector(d,this.vel));c.call(this)}},receiveTransform:function(a){this.addTransform(a);var b=this.toLoad[a.name];if(b!=null){var c=this.transformObjs[this.transformObjs.length-1],d=c.offTran,e=c.rotTran;e.parent.localMatrix=b[0],e.localMatrix=b[1],d.localMatrix=b[2],delete this.toLoad[a.name]}},removeTransforms:function(a){for(var c=0;c<this.transformObjs.length;++c){var d=this.transformObjs[c];a===d.owner&&(b.call(this,d),--c)}},setAccel:function(a){this.accel=a,d.call(this)},setAngle:function(a){this.angle=a,c.call(this)},setOrigin:function(b){this.origin=b,this.offset=a.core.math.mulScalarVector(-1,b)},setVel:function(a){this.vel=a,d.call(this)},toOctane:function(){var a=this._super(),b=["accel","angle","vel"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}a.props.push({name:"setOrigin",arg:[this.origin]});var f={};for(var g=0,h=this.transformObjs.length;g<h;g++){var i=this.transformObjs[g],j=i.offTran,k=i.rotTran;f[j.name]=[i.parent.localMatrix,k.localMatrix,j.localMatrix]}return a.props.push({name:"toLoad",val:f}),a}}),a.motion.Rotator.prototype.msgSent=a.motion.Rotator.prototype.msgSent.concat([a.msg.start,a.msg.stop]),a.motion.Translator=a.world.Citizen.extend({init:function(a,b){this._super();var c=b||{};this.pos=c.pos||[0,0,0],this.vel=c.vel||[0,0,0],this.accel=c.accel||[0,0,0],this.time=0,this.stopTime=0,this.mustComplete=!1,this.steadyMove=!1,this.startPos=this.pos,this.stopPos=this.pos,this.toLoad={},this.transformObjs=[],a!=null&&this.addTransform(a),this.enable()},addTransform:function(b){a.world.tranReg.register(b,this);var c=b.getParam("ownerId"),d={},f=null,g=null;c!==null&&(f=c.value,g=a.world.getCitizenById(f));if(a.utils.isAnimated(b))d.tran=a.utils.fosterTransform(b),d.tran.name=b.name+" Translator",c=d.tran.createParam("ownerId","o3d.ParamInteger"),c.value=f,d.parent=b.parent,d.foster=!0;else{var h=a.core.mainPack.createObject("Transform");h.name=b.name+" Translator",c=h.createParam("ownerId","o3d.ParamInteger"),c.value=f,h.parent=b.parent,b.parent=h,h.localMatrix=a.utils.clone(b.localMatrix),b.identity(),d.tran=b,d.parent=h,d.foster=!1}if(g){var i=this;d.owner=g,d.msg=g.subscribe(a.msg.cleanup,function(a){i.removeTransforms(a.src)})}this.transformObjs.push(d),e.call(this,[d])},citizenType:"hemi.motion.Translator",cleanup:function(){this.disable(),this._super(),this.clearTransforms()},clear:function(){this.pos=[0,0,0],this.vel=[0,0,0],this.accel=[0,0,0]},clearTransforms:function(){while(this.transformObjs.length>0)f.call(this,this.transformObjs[0])},disable:function(){this.enabled&&(a.view.removeRenderListener(this),this.enabled=!1)},enable:function(){this.enabled=!0,d.call(this)},getTransforms:function(){var a=[];for(var b=0,c=this.transformObjs.length;b<c;b++){var d=this.transformObjs[b];d.foster?a.push(d.tran.parent):a.push(d.tran)}return a},move:function(b,c,d){return!this.enabled||this.mustComplete?!1:(this.time=0,this.stopTime=c||.001,this.steadyMove=!0,this.startPos=this.pos,this.mustComplete=d||!1,this.stopPos=a.core.math.addVector(this.pos,b),a.view.addRenderListener(this),this.send(a.msg.start,{}),!0)},onRender:function(b){if(this.transformObjs.length>0){var c=b.elapsedTime;if(this.steadyMove){this.time+=c,this.time>=this.stopTime&&(this.time=this.stopTime,this.steadyMove=this.mustComplete=!1,a.view.removeRenderListener(this),this.send(a.msg.stop,{}));var d=this.time/this.stopTime;this.pos=a.core.math.lerpVector(this.startPos,this.stopPos,d)}else this.vel=a.core.math.addVector(this.vel,a.core.math.mulScalarVector(c,this.accel)),this.pos=a.core.math.addVector(this.pos,a.core.math.mulScalarVector(c,this.vel));e.call(this)}},receiveTransform:function(a){this.addTransform(a);var b=this.toLoad[a.name];b!=null&&(a.parent.localMatrix=b[0],a.localMatrix=b[1],delete this.toLoad[a.name])},removeTransforms:function(a){for(var b=0;b<this.transformObjs.length;++b){var c=this.transformObjs[b];a===c.owner&&(f.call(this,c),--b)}},setAccel:function(a){this.accel=a,d.call(this)},setPos:function(a){this.pos=a,e.call(this)},setVel:function(a){this.vel=a,d.call(this)},toOctane:function(){var a=this._super(),b=["pos","vel","accel"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}var f={};for(var g=0,h=this.transformObjs.length;g<h;g++){var i=this.transformObjs[g],j=i.tran;f[j.name]=[i.parent.localMatrix,j.localMatrix]}return a.props.push({name:"toLoad",val:f}),a}}),a.motion.Translator.prototype.msgSent=a.motion.Translator.prototype.msgSent.concat([a.msg.start,a.msg.stop]);var b=function(b){var c=b.rotTran,d=b.offTran,e;if(b.foster)e=c.parent,c.parent=null,d.parent=e,a.core.mainPack.removeObject(c),a.utils.unfosterTransform(d);else{var f=b.parent,g=f.children[0],h=c.children[0];g&&(g.parent=f.parent),h&&(h.localMatrix=f.localMatrix,h.parent=c.parent),e=d,f.parent=c.parent=null,a.core.mainPack.removeObject(f),a.core.mainPack.removeObject(c)}a.world.tranReg.unregister(e,this);var i=this.transformObjs.indexOf(b);i>-1&&this.transformObjs.splice(i,1),b.owner&&b.msg&&b.owner.unsubscribe(b.msg,a.msg.cleanup)},c=function(a){var b=this.transformObjs;a&&(b=a);for(var c=0,d=b.length;c<d;c++){var e=b[c];e.offTran.identity(),e.offTran.translate(this.offset),e.rotTran.identity(),e.rotTran.translate(this.origin),e.rotTran.rotateZYX(this.angle)}},d=function(){!this.enabled||this.accel.join()==="0,0,0"&&this.vel.join()==="0,0,0"?a.view.removeRenderListener(this):a.view.addRenderListener(this)},e=function(a){var b=this.transformObjs;a&&(b=a);for(var c=0,d=b.length;c<d;c++){var e=b[c].tran;e.identity(),e.translate(this.pos)}},f=function(b){var c;if(b.foster)c=a.utils.unfosterTransform(b.tran);else{var d=b.parent,e=d.children[0];e&&(e.localMatrix=d.localMatrix,e.parent=d.parent),c=b.tran,d.parent=null,a.core.mainPack.removeObject(d)}a.world.tranReg.unregister(c,this);var f=this.transformObjs.indexOf(b);f>-1&&this.transformObjs.splice(f,1),b.owner&&b.msg&&b.owner.unsubscribe(b.msg,a.msg.cleanup)};return a}(hemi||{}),hemi=function(a){return a.effect=a.effect||{},a.effect.ParticleFunctions={Acceleration:"Acceleration",Puff:"Puff"},a.effect.ParticleFunction=function(){this.name=null,this.options={}},a.effect.ParticleFunction.prototype={toOctane:function(){var a={type:"hemi.effect.ParticleFunction",props:[]};return a.props.push({name:"name",val:this.name}),a.props.push({name:"options",val:this.options}),a}},a.effect.Effect=a.world.Citizen.extend({init:function(){this._super(),this.state=a.core.particles.ParticleStateIds.BLEND,this.colorRamp=[],this.params={},this.particleFunction=null,this.particles=null,this.transform=a.effect.particlePack.createObject("Transform"),this.transform.parent=a.core.client.root},citizenType:"hemi.effect.Effect",cleanup:function(){this._super(),this.particles=null,this.transform.parent=null,a.effect.particlePack.removeObject(this.transform),this.transform=null},setup:function(){},toOctane:function(){var a=this._super(),b=["state","colorRamp","params"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return this.particleFunction!==null&&a.props.push({name:"particleFunction",oct:this.particleFunction.toOctane()}),a.props.push({name:"setup",arg:[]}),a}}),a.effect.Emitter=a.effect.Effect.extend({init:function(){this._super(),this.visible=!1},citizenType:"hemi.effect.Emitter",hide:function(){this.particles===null&&this.setup(),this.visible&&(this.visible=!1,this.transform.removeShape(this.particles.shape),this.send(a.msg.visible,{visible:this.visible}))},setup:function(){var b=a.utils.clone(this.params),c;this.particleFunction!==null&&(c=a.effect.getParticleFunction(this.particleFunction)),this.particles=a.effect.particleSystem.createParticleEmitter(),this.particles.setState(this.state),this.particles.setColorRamp(this.colorRamp),this.particles.setParameters(b,c)},show:function(){this.particles===null&&this.setup(),this.visible||(this.visible=!0,this.transform.addShape(this.particles.shape),this.send(a.msg.visible,{visible:this.visible}))}}),a.effect.Emitter.prototype.msgSent=a.effect.Emitter.prototype.msgSent.concat([a.msg.visible]),a.effect.Burst=a.effect.Emitter.extend({init:function(){this._super(),this.oneShot=null},citizenType:"hemi.effect.Burst",cleanup:function(){this._super(),this.oneShot=null},setup:function(){this._super(),this.oneShot=this.particles.createOneShot(this.transform)},trigger:function(){this.oneShot===null&&this.setup(),this.oneShot.trigger(this.params.position),this.send(a.msg.burst,{position:this.params.position})}}),a.effect.Burst.prototype.msgSent=a.effect.Burst.prototype.msgSent.concat([a.msg.burst]),a.effect.Trail=a.effect.Effect.extend({init:function(){this._super(),this.isAnimating=!1,this.fireInterval=1,this.count=0},citizenType:"hemi.effect.Trail",onRender:function(a){this.count+=a.elapsedTime,this.count>=this.fireInterval&&(this.count=0,this.particles.birthParticles(this.params.position))},setup:function(){var b=a.utils.clone(this.params),c,d=this.params.numParticles||1,e=this.params.lifeTime||1+this.params.lifeTimeRange||0,f=e/this.fireInterval+1,g=parseInt(f*d);this.particleFunction!==null&&(c=a.effect.getParticleFunction(this.particleFunction));var h;this.particles=a.effect.particleSystem.createTrail(this.transform,g,b,h,c),this.particles.setState(this.state),this.particles.setColorRamp(this.colorRamp)},start:function(){this.particles===null&&this.setup(),this.isAnimating||(this.isAnimating=!0,a.view.addRenderListener(this),this.send(a.msg.start,{}))},stop:function(){this.particles===null&&this.setup(),this.isAnimating&&(a.view.removeRenderListener(this),this.isAnimating=!1,this.count=0,this.send(a.msg.stop,{}))},toOctane:function(){var a=this._super();return a.props.unshift({name:"fireInterval",val:this.fireInterval}),a}}),a.effect.Trail.prototype.msgSent=a.effect.Trail.prototype.msgSent.concat([a.msg.start,a.msg.stop]),a.effect.init=function(){this.particlePack=a.core.client.createPack(),this.particleSystem=a.core.particles.createParticleSystem(this.particlePack,a.view.viewInfo)},a.effect.createEmitter=function(b,c,d,e){var f=new a.effect.Emitter;return f.state=b,f.colorRamp=c,f.params=d,e&&(f.particleFunction=e),f.setup(),f},a.effect.createBurst=function(b,c,d,e){var f=new a.effect.Burst;return f.state=b,f.colorRamp=c,f.params=d,e&&(f.particleFunction=e),f.setup(),f},a.effect.createTrail=function(b,c,d,e,f){var g=new a.effect.Trail;return g.state=b,g.colorRamp=c,g.params=d,g.fireInterval=e,f&&(g.particleFunction=f),g.setup(),g},a.effect.getParticleFunction=function(b){var c;switch(b.name){case a.effect.ParticleFunctions.Acceleration:c=this.getAccelerationFunction(b.options);break;case a.effect.ParticleFunctions.Puff:c=this.getPuffFunction(b.options);break;default:c=null}return c},a.effect.getAccelerationFunction=function(a){var b=function(a,c){c.acceleration=[b.factor[0]*c.velocity[0],b.factor[1]*c.velocity[1],b.factor[2]*c.velocity[2]]};return b.factor=a.factor===undefined?[0,0,0]:a.factor,b},a.effect.getPuffFunction=function(b){var c=function(b,d){var e=Math.random()*2*Math.PI,f=.8*c.size,g=-0.003*c.size;d.velocity=a.core.math.matrix4.transformPoint(a.core.math.matrix4.rotationY(7*e),[f,f,f]),d.velocity=a.core.math.matrix4.transformPoint(a.core.math.matrix4.rotationX(e),d.velocity),d.acceleration=a.core.math.mulVectorVector(d.velocity,[g,g,g]),d.acceleration=a.core.math.addVector(d.acceleration,c.wind)};return c.wind=b.wind===undefined?[0,0,0]:b.wind,c.size=b.size===undefined?1:b.size,c},a}(hemi||{}),hemi=function(a){return a.scene=a.scene||{},a.scene.Scene=a.world.Citizen.extend({init:function(){this._super(),this.isLoaded=!1,this.next=null,this.prev=null},citizenType:"hemi.scene.Scene",cleanup:function(){this._super(),this.next!==null&&(this.next.prev=this.prev),this.prev!==null&&(this.prev.next=this.next),this.next=null,this.prev=null},toOctane:function(){var a=this._super();return this.next===null?a.props.push({name:"next",val:null}):a.props.push({name:"next",id:this.next.getId()}),this.prev===null?a.props.push({name:"prev",val:null}):a.props.push({name:"prev",id:this.prev.getId()}),a},load:function(){this.isLoaded||(this.isLoaded=!0,this.send(a.msg.load,{}))},unload:function(){this.isLoaded&&(this.isLoaded=!1,this.send(a.msg.unload,{}))},nextScene:function(){this.isLoaded&&this.next!=null&&(this.unload(),this.next.load())},previousScene:function(){this.isLoaded&&this.prev!=null&&(this.unload(),this.prev.load())}}),a.scene.Scene.prototype.msgSent=a.scene.Scene.prototype.msgSent.concat([a.msg.load,a.msg.unload]),a}(hemi||{}),hemi=function(a){a.hud=a.hud||{},a.hud.init=function(){this.pack=a.core.client.createPack(),this.theme=new a.hud.Theme,this.theme.name="Default",this.hudMgr=new a.hud.HudManager},a.hud.cleanup=function(){this.pack.destroy(),this.pack=null,this.hudMgr=null,this.theme=null},a.hud.setTheme=function(a){this.theme=a},a.hud.Theme=a.world.Citizen.extend({init:function(){this._super(),this.image={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}},this.page={color:[0,0,0,.45],curve:0,shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,0]},outline:null},this.text={textSize:12,textTypeface:"helvetica",textAlign:"center",textStyle:"bold",strictWrapping:!0,lineMargin:5,color:[1,1,.6,1],shadow:{radius:.5,offsetY:1,offsetX:1,color:[0,0,0,1]},outline:null},this.video={shadow:{radius:0,offsetY:0,offsetX:0,color:[0,0,0,1]}}},citizenType:"hemi.hud.Theme",load:function(){a.hud.setTheme(this)},toOctane:function(){var a=this._super();return a.props.push({name:"image",val:this.image}),a.props.push({name:"page",val:this.page}),a.props.push({name:"text",val:this.text}),a.props.push({name:"load",arg:[]}),a}}),a.hud.HudElement=a.world.Citizen.extend({init:function(){this._super(),this.visible=!0,this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.top=0,this.bottom=0,this.left=0,this.right=0,this.config={}},citizenType:"hemi.hud.HudElement",cleanup:function(){this._super(),this.mouseDown=null,this.mouseUp=null,this.mouseMove=null,this.config={}},toOctane:function(){var a=this._super();return a.props.push({name:"top",val:this.top}),a.props.push({name:"bottom",val:this.bottom}),a.props.push({name:"left",val:this.left}),a.props.push({name:"right",val:this.right}),a.props.push({name:"config",val:this.config}),a},calculateBounds:function(){},checkEvent:function(a){var b=a.x<=this.right&&a.x>=this.left&&a.y<=this.bottom&&a.y>=this.top;return b},draw:function(){},onMouseDown:function(a){var b=this.checkEvent(a);return b&&this.mouseDown&&this.mouseDown(a),b},onMouseMove:function(a){if(this.mouseMove){var b=this.checkEvent(a);this.mouseMove(a,b)}},onMouseUp:function(a){var b=this.checkEvent(a);return b&&this.mouseUp&&this.mouseUp(a),b},setConfig:function(a){this.config=a}}),a.hud.HudText=a.hud.HudElement.extend({init:function(){this._super(),this.x=0,this.y=0,this.wrappedText=[],this.wrappedHeight=0,this.wrappedWidth=0,this.text=[],this.width=0},citizenType:"hemi.hud.HudText",toOctane:function(){var a=this._super();return a.props.push({name:"x",val:this.x}),a.props.push({name:"y",val:this.y}),a.props.push({name:"setText",arg:[this.text]}),a.props.push({name:"setWidth",arg:[this.width]}),a},calculateBounds:function(){var b;this.config.textAlign!=null?b=this.config.textAlign.toLowerCase():b=a.hud.theme.text.textAlign.toLowerCase(),this.top=this.y,this.bottom=this.top+this.wrappedHeight;switch(b){case"left":this.left=this.x,this.right=this.left+this.wrappedWidth;break;case"right":this.right=this.x,this.left=this.right-this.wrappedWidth;break;default:var c=this.wrappedWidth/2;this.left=this.x-c,this.right=this.x+c}},draw:function(){a.hud.hudMgr.createTextOverlay(this.wrappedText,this.config,this.x,this.y)},setConfig:function(a){this._super(a),this.wrapText()},setText:function(a){a instanceof Array?this.text=a:this.text=[a],this.wrapText()},setWidth:function(a){this.width=a,this.wrapText()},wrapText:function(){if(this.width<=0||this.text.length<=0)return;var b=0,c=0,d=[];for(var e=0,f=this.text.length;e<f;e++){var g=a.hud.hudMgr.doTextWrapping(this.text[e],this.width,this.config);g.width>b&&(b=g.width),c+=g.height,d=d.concat(g.text)}this.wrappedWidth=b,this.wrappedHeight=c,this.wrappedText=d}}),a.hud.HudImage=a.hud.HudElement.extend({init:function(){this._super(),this.x=0,this.y=0,this.srcX=0,this.srcY=0,this.height=0,this.width=0,this.image=null,this.url=null},citizenType:"hemi.hud.HudImage",cleanup:function(){this._super(),this.image=null},toOctane:function(){var a=this._super();return a.props.push({name:"x",val:this.x}),a.props.push({name:"y",val:this.y}),a.props.push({name:"srcX",val:this.srcX}),a.props.push({name:"srcY",val:this.srcY}),a.props.push({name:"setImageUrl",arg:[this.url]}),a},calculateBounds:function(){this.top=this.y,this.bottom=this.top+this.height,this.left=this.x,this.right=this.left+this.width},draw:function(){this.width!==this.image.width||this.height!==this.image.height||this.srcX!==0||this.srcY!==0?a.hud.hudMgr.createImageOverlay(this.image,this.config,this.x,this.y,this.srcX,this.srcY,this.width,this.height):a.hud.hudMgr.createImageOverlay(this.image,this.config,this.x,this.y)},getImageUrl:function(){return this.url},setImageUrl:function(a){this.url=a,this.image!==null&&(this.image=null),this.loadImage()},loadImage:function(){var b=this;a.loader.loadImage(this.url,function(c){b.image=c,b.height=c.height,b.width=c.width,b.send(a.msg.load,{})})}}),a.hud.HudImage.prototype.msgSent=a.hud.HudImage.prototype.msgSent.concat([a.msg.load]),a.hud.HudButton=a.hud.HudElement.extend({init:function(){this._super(),this.x=0,this.y=0,this.enabled=!0,this.selected=!1,this.hovering=!1,this.enabledImg=null,this.disabledImg=null,this.selectedImg=null,this.hoverImg=null;var a=this;this.mouseMove=function(b,c){if(a.enabled==0||a.selected)return;c?a.hovering||(a.hovering=!0,a.draw()):a.hovering&&(a.hovering=!1,a.draw())}},cleanup:function(){this._super(),this.mouseMove=null,this.enabledImg&&(this.enabledImg.cleanup(),this.enabledImg=null),this.disabledImg&&(this.disabledImg.cleanup(),this.disabledImg=null),this.selectedImg&&(this.selectedImg.cleanup(),this.selectedImg=null),this.hoverImg&&(this.hoverImg.cleanup(),this.hoverImg=null)},select:function(a){this.selected=a,this.draw()},toOctane:function(){var a=this._super();return a.props.push({name:"x",val:this.x}),a.props.push({name:"y",val:this.y}),a.props.push({name:"enabledImg",id:this.enabledImg.getId()}),a.props.push({name:"disabledImg",id:this.disabledImg.getId()}),a.props.push({name:"hoverImg",id:this.hoverImg.getId()}),a.props.push({name:"selectedImg",id:this.selectedImg.getId()}),a},calculateBounds:function(){var a=this.getImage();this.top=this.y,this.bottom=this.top+a.height,this.left=this.x,this.right=this.left+a.width},draw:function(){var a=this.getImage();a.x=this.x,a.y=this.y,a.draw()},setImages:function(b,c,d,e){var f=this;b!=null&&(this.disabledImg=new a.hud.HudImage,this.disabledImg.setImageUrl(b)),e!=null&&(this.selectedImg=new a.hud.HudImage,this.selectedImg.setImageUrl(e)),c!=null&&(this.enabledImg=new a.hud.HudImage,this.enabledImg.setImageUrl(c)),d!=null&&(this.hoverImg=new a.hud.HudImage,this.hoverImg.setImageUrl(d))},getImage:function(){var a=this.enabledImg;return this.enabled?this.selected?this.selectedImg&&(a=this.selectedImg):this.hovering&&this.hoverImg&&(a=this.hoverImg):this.disabledImg&&(a=this.disabledImg),a},setCoords:function(b){var c=b.disabled,d=b.enabled,e=b.hover;this.enabledImg===null&&(this.enabledImg=new a.hud.HudImage),this.disabledImg===null&&(this.disabledImg=new a.hud.HudImage),this.hoverImg===null&&(this.hoverImg=new a.hud.HudImage),d!=null&&(this.enabledImg.srcX=d[0],this.enabledImg.srcY=d[1]),c!=null&&(this.disabledImg.srcX=c[0],this.disabledImg.srcY=c[1]),e!=null&&(this.hoverImg.srcX=e[0],this.hoverImg.srcY=e[1])},setUrls:function(b){var c=b.disabled,d=b.enabled,e=b.hover,f=this;if(!d)return;this.enabledImg===null&&(this.enabledImg=new a.hud.HudImage),this.disabledImg===null&&(this.disabledImg=new a.hud.HudImage),this.hoverImg===null&&(this.hoverImg=new a.hud.HudImage);var g=this.enabledImg.subscribe(a.msg.load,function(a){f.disabledImg.url===null&&(f.disabledImg.url=d,f.disabledImg.image=f.enabledImg.image,f.disabledImg.height=f.enabledImg.height,f.disabledImg.width=f.enabledImg.width),f.hoverImg.url===null&&(f.hoverImg.url=d,f.hoverImg.image=f.enabledImg.image,f.hoverImg.height=f.enabledImg.height,f.hoverImg.width=f.enabledImg.width),f.enabledImg.unsubscribe(g)});c!=null&&c!==d&&this.disabledImg.setImageUrl(c),e!=null&&e!==d&&this.hoverImg.setImageUrl(e),this.enabledImg.setImageUrl(d)}}),a.hud.HudVideo=a.hud.HudElement.extend({init:function(){this._super(),this.x=0,this.y=0,this.height=0,this.width=0,this.urls=[],this.video=document.createElement("video");var b=this.video,c=this;this.video.onloadeddata=function(){c.height===0?c.height=b.videoHeight:b.setAttribute("height",""+c.height),c.width===0?c.width=b.videoWidth:b.setAttribute("width",""+c.width),c.send(a.msg.load,{src:b.currentSrc})}},citizenType:"hemi.hud.HudVideo",addVideoUrl:function(b,c){var d=document.createElement("source"),e=a.loader.getPath(b);d.setAttribute("src",e),d.setAttribute("type","video/"+c),this.video.appendChild(d),this.urls.push({url:b,type:c,node:d})},cleanup:function(){this._super(),this.video=null,this.urls=[]},toOctane:function(){var a=this._super();a.props.push({name:"x",val:this.x}),a.props.push({name:"y",val:this.y});for(var b=0,c=this.urls.length;b<c;b++){var d=this.urls[b];a.props.push({name:"addVideoUrl",arg:[d.url,d.type]})}return a},calculateBounds:function(){this.top=this.y,this.bottom=this.top+this.height,this.left=this.x,this.right=this.left+this.width},draw:function(){a.hud.hudMgr.createVideoOverlay(this.video,this.config,this.x,this.y,this.width,this.height)},removeVideoUrl:function(a){for(var b=0,c=this.urls.length;b<c;b++){var d=this.urls[b];if(d.url===a){this.video.removeChild(d.node),this.urls.splice(b,1);break}}},setHeight:function(a){this.height=a,this.video!==null&&this.video.setAttribute("height",""+a)},setWidth:function(a){this.width=a,this.video!==null&&this.video.setAttribute("width",""+a)}}),a.hud.HudVideo.prototype.msgSent=a.hud.HudVideo.prototype.msgSent.concat([a.msg.load]),a.hud.HudPage=a.hud.HudElement.extend({init:function(){this._super(),this.drawBackground=!0,this.margin=5,this.elements=[],this.auto=!0},citizenType:"hemi.hud.HudPage",cleanup:function(){this._super();for(var a=0,b=this.elements.length;a<b;a++)this.elements[a].cleanup();this.elements=[]},toOctane:function(){var a=this._super();a.props.push({name:"auto",val:this.auto}),a.props.push({name:"drawBackground",val:this.drawBackground}),a.props.push({name:"margin",val:this.margin});var b={name:"elements",id:[]};for(var c=0,d=this.elements.length;c<d;c++)b.id.push(this.elements[c].getId());return a.props.push(b),a},autosize:function(){this.auto=!0},calculateBounds:function(){var a,b=this.elements.length;if(b<=0){this.top=0,this.bottom=0,this.left=0,this.right=0;return}for(a=0;a<b;a++)this.elements[a].calculateBounds();if(this.auto){var c=this.elements[0];this.top=c.top,this.bottom=c.bottom,this.left=c.left,this.right=c.right;for(a=1;a<b;a++)c=this.elements[a],c.top<this.top&&(this.top=c.top),c.bottom>this.bottom&&(this.bottom=c.bottom),c.left<this.left&&(this.left=c.left),c.right>this.right&&(this.right=c.right);this.top-=this.margin,this.bottom+=this.margin,this.left-=this.margin,this.right+=this.margin}},draw:function(){this.calculateBounds(),this.drawBackground&&a.hud.hudMgr.createRectangleOverlay(this,this.config);for(var b=0,c=this.elements.length;b<c;b++)this.elements[b].visible&&this.elements[b].draw()},addElement:function(a){var b=this.elements.indexOf(a);b==-1&&this.elements.push(a)},clearElements:function(){this.elements=[]},removeElement:function(a){var b=null,c=this.elements.indexOf(a);if(c!=-1){var d=this.elements.splice(c,1);d.length==1&&(b=d[0])}return b},onMouseDown:function(a){if(!this.visible)return!1;var b=this.checkEvent(a);if(b||!this.auto){var c=!1,d=this.elements.length;for(var e=0;e<d&&!c;e++)this.elements[e].visible&&(c=this.elements[e].onMouseDown(a));b&&!c&&this.mouseDown&&this.mouseDown(a)}return b},onMouseMove:function(a){if(!this.visible)return;for(var b=0,c=this.elements.length;b<c;b++)this.elements[b].visible&&this.elements[b].onMouseMove(a);if(this.mouseMove){var d=this.checkEvent(a);this.mouseMove(a,d)}},onMouseUp:function(a){var b=this.checkEvent(a);if(b||!this.auto){var c=!1,d=this.elements.length;for(var e=0;e<d&&!c;e++)c=this.elements[e].onMouseUp(a);b&&!c&&this.mouseUp&&this.mouseUp(a)}return b},setSize:function(a,b,c,d){this.top=a,this.bottom=b,this.left=c,this.right=d,this.auto=!1}}),a.hud.HudDisplay=a.world.Citizen.extend({init:function(){this._super(),this.visible=!1,this.pages=[],this.currentPage=0},citizenType:"hemi.hud.HudDisplay",cleanup:function(){this._super();for(var a=0,b=this.pages.length;a<b;a++)this.pages[a].cleanup();this.pages=[]},toOctane:function(){var a=this._super(),b={name:"pages",id:[]};for(var c=0,d=this.pages.length;c<d;c++)b.id.push(this.pages[c].getId());return a.props.push(b),a},isVisible:function(){return this.visible},addPage:function(a){var b=this.pages.indexOf(a);b==-1&&this.pages.push(a)},removePage:function(a){var b=null,c=this.pages.indexOf(a);if(c!=-1){this.visible&&c===this.currentPage&&(c!==0?this.previousPage():this.pages.length>1?this.nextPage():this.hide());var d=this.pages.splice(c,1);d.length==1&&(b=d[0])}return b},clearPages:function(){this.visible&&this.hide(),this.pages=[]},getCurrentPage:function(){var a=null;return this.currentPage<this.pages.length&&(a=this.pages[this.currentPage]),a},getNumberOfPages:function(){return this.pages.length},nextPage:function(){var a=this.pages.length;this.currentPage++,this.currentPage>=a?this.currentPage=a-1:this.showPage()},previousPage:function(){this.currentPage--,this.currentPage<0?this.currentPage=0:this.showPage()},show:function(){this.visible||(this.visible=!0,this.showPage(),a.input.addMouseDownListener(this),a.input.addMouseUpListener(this),a.input.addMouseMoveListener(this))},showPage:function(){a.hud.hudMgr.clearDisplay();var b=this.getCurrentPage();b.draw(),this.send(a.msg.visible,{page:this.currentPage+1})},hide:function(){this.visible&&(a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),a.input.removeMouseDownListener(this),a.hud.hudMgr.clearDisplay(),this.visible=!1,this.currentPage=0,this.send(a.msg.visible,{page:0}))},onMouseDown:function(a){var b=this.getCurrentPage(),c=!1;return b&&(c=b.onMouseDown(a)),c},onMouseMove:function(a){var b=this.getCurrentPage();b&&b.onMouseMove(a)},onMouseUp:function(a){var b=this.getCurrentPage(),c=!1;return b&&(c=b.onMouseUp(a)),c}}),a.hud.HudDisplay.prototype.msgSent=a.hud.HudDisplay.prototype.msgSent.concat([a.msg.visible]),a.hud.HudManager=function(){var b=document.getElementById("o3d"),c=b.firstElementChild,d=document.createElement("canvas"),e=d.style;this.videos=[],e.left=c.offsetLeft+"px",e.position="absolute",e.top=c.offsetTop+"px",e.zIndex="10",d.height=c.height,d.width=c.width,b.appendChild(d),this.canvas=d.getContext("2d"),this.canvas.textBaseline="top",this.wheelHandler=o3d.Client.wrapEventCallback_(a.input.scroll,!0),this.downHandler=o3d.Client.wrapEventCallback_(a.input.mouseDown,!1),this.moveHandler=o3d.Client.wrapEventCallback_(a.input.mouseMove,!1),this.upHandler=o3d.Client.wrapEventCallback_(a.input.mouseUp,!1),d.addEventListener("DOMMouseScroll",this.wheelHandler,!0),d.addEventListener("mousewheel",this.wheelHandler,!0),d.addEventListener("mousedown",this.downHandler,!0),d.addEventListener("mousemove",this.moveHandler,!0),d.addEventListener("mouseup",this.upHandler,!0),this.canvasElem=d,a.view.addRenderListener(this)},a.hud.HudManager.prototype={setPaintProperties:function(a){var c;a.color!=null&&(this.canvas.fillStyle=b(a.color));if(a.outline!=null)this.canvas.strokeStyle=b(a.outline),this.canvas.shadowColor="rgba(0,0,0,0)";else if(a.shadow!=null){var d=a.shadow;this.canvas.shadowBlur=d.radius,this.canvas.shadowColor=b(d.color),this.canvas.shadowOffsetX=d.offsetX,this.canvas.shadowOffsetY=d.offsetY}else this.canvas.shadowColor="rgba(0,0,0,0)";a.textAlign!=null&&(this.canvas.textAlign=a.textAlign),a.textStyle!=null?c=a.textStyle+" ":c="bold ",a.textSize!=null?c+=a.textSize+"px ":c+="12px ",a.textTypeface!=null?c+='"'+a.textTypeface+'"':c+="helvetica",c!=null&&(this.canvas.font=c)},createRectangleOverlay:function(b,c){var d=a.utils.join({},a.hud.theme.page,c);this.canvas.save(),this.setPaintProperties(d);if(d.curve>0){var e=d.curve<=1?d.curve/2:.5;this.drawRoundRect(b,e,!0),d.outline!=null&&this.drawRoundRect(b,e,!1)}else{var f=b.left,g=b.top,h=b.right-f,i=b.bottom-g;this.canvas.fillRect(f,g,h,i),d.outline!=null&&this.canvas.strokeRect(f,g,h,i)}this.canvas.restore()},createTextOverlay:function(b,c,d,e){var f=a.utils.join({},a.hud.theme.text,c),g=f.textSize,h=f.outline!=null;this.canvas.save(),this.setPaintProperties(f);for(var i=0,j=b.length;i<j;i++){var k=b[i];this.canvas.fillText(k,d,e),h&&this.canvas.strokeText(k,d,e),e+=g+f.lineMargin}this.canvas.restore()},createImageOverlay:function(b,c,d,e,f,g,h,i){var j=a.utils.join({},a.hud.theme.image,c);this.canvas.save(),this.setPaintProperties(j),f!=null&&g!=null&&h!=null&&i!=null?this.canvas.drawImage(b,f,g,h,i,d,e,h,i):this.canvas.drawImage(b,d,e),this.canvas.restore()},createVideoOverlay:function(b,c,d,e,f,g){var h=a.utils.join({},a.hud.theme.video,c);this.videos.push({video:b,config:h,x:d,y:e,width:f||b.videoWidth,height:g||b.videoHeight}),b.play()},clearDisplay:function(){var a=this.canvas.canvas,b=this.videos;this.videos=[];for(var c=0,d=b.length;c<d;c++)b[c].video.pause();this.canvas.clearRect(0,0,a.width,a.height),this.canvas.beginPath()},doTextWrapping:function(b,c,d){var e=a.utils.join({},a.hud.theme.text,d),f;this.canvas.save(),this.setPaintProperties(e);if(e.strictWrapping)f=a.utils.wrapTextStrict(b,c,this.canvas);else{var g=this.canvas.measureText(b),h=g.width/b.length;f=a.utils.wrapText(b,c,h)}var i=f.length*(e.textSize+e.lineMargin),j=0;for(var k=0,l=f.length;k<l;k++){var g=this.canvas.measureText(f[k]);j<g.width&&(j=g.width)}return this.canvas.restore(),{text:f,height:i,width:j}},drawRoundRect:function(b,c,d){var e=a.core.math,f=b.left,g=b.right,h=b.top,i=b.bottom,j=g-f,k=i-h,l=k>j?j*c:k*c,m=e.degToRad(270),n=0,o=e.degToRad(90),p=e.degToRad(180);this.canvas.beginPath(),this.canvas.moveTo(f,h+l),this.canvas.lineTo(f,i-l),this.canvas.arc(f+l,i-l,l,p,o,!0),this.canvas.lineTo(g-l,i),this.canvas.arc(g-l,i-l,l,o,n,!0),this.canvas.lineTo(g,h+l),this.canvas.arc(g-l,h+l,l,n,m,!0),this.canvas.lineTo(f+l,h),this.canvas.arc(f+l,h+l,l,m,p,!0),this.canvas.closePath(),d?this.canvas.fill():this.canvas.stroke()},onRender:function(a){var b=this.videos,c=this.canvas,d;for(var e=0,f=b.length;e<f;e++)d=b[e],this.canvas.save(),this.setPaintProperties(d.config),c.drawImage(d.video,d.x,d.y,d.width,d.height),this.canvas.restore()}};var b=function(a){return"rgba("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+","+a[3]+")"};return a}(hemi||{}),hemi=function(a){function c(a,b){var d=a.clientId===b.clientId;if(!d){var e=a.children;for(var f=0,g=e.length;f<g&&!d;f++)d=d||c(e[f],b)}return d}a.manip=a.manip||{},a.manip.Plane={XY:"xy",XZ:"xz",YZ:"yz",get:function(b){var c=null;return a.utils.compareArrays(b,[[0,0,0],[1,0,0],[0,1,0]])?c=this.XY:a.utils.compareArrays(b,[[0,0,0],[1,0,0],[0,0,1]])?c=this.XZ:a.utils.compareArrays(b,[[0,0,0],[0,0,1],[0,1,0]])&&(c=this.YZ),c}},a.manip.Axis={X:"x",Y:"y",Z:"z"},a.manip.Draggable=a.world.Citizen.extend({init:function(a,b,c){this._super(),this.activeTransform=null,this.dragUV=null,this.enabled=!1,this.local=!1,this.msgHandler=null,this.plane=null,this.transformObjs=[],this.umin=null,this.umax=null,this.uv=c==null?[0,0]:c,this.vmin=null,this.vmax=null,a!=null&&this.setPlane(a),b!=null&&this.setLimits(b),this.enable()},citizenType:"hemi.manip.Draggable",cleanup:function(){this.disable(),this._super(),this.clearTransforms(),this.msgHandler=null},toOctane:function(){var a=this._super(),b=["local","plane","umin","umax","vmin","vmax"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a},addTransform:function(b){a.world.tranReg.register(b,this);var c=b.getParam("ownerId"),d={},e=null;c!==null&&(e=a.world.getCitizenById(c.value)),a.utils.isAnimated(b)?(d.transform=a.utils.fosterTransform(b),d.foster=!0):(d.transform=b,d.foster=!1);if(e){var f=this;d.owner=e,d.msg=e.subscribe(a.msg.cleanup,function(a){f.removeTransforms(a.src)})}this.transformObjs.push(d)},clamp:function(a){var b=this.uv[0]+a[0],c=this.uv[1]+a[1];return this.umin!=null&&b<this.umin&&(b=this.umin),this.umax!=null&&b>this.umax&&(b=this.umax),this.vmin!=null&&c<this.vmin&&(c=this.vmin),this.vmax!=null&&c>this.vmax&&(c=this.vmax),a=[b-this.uv[0],c-this.uv[1]],this.uv=[b,c],a},clearLimits:function(){this.umin=null,this.umax=null,this.vmin=null,this.vmax=null},clearTransforms:function(){while(this.transformObjs.length>0)b.call(this,this.transformObjs[0])},containsTransform:function(a){for(var b=0;b<this.transformObjs.length;b++){var c=this.transformObjs[b].transform.getTransformsInTree();for(var d=0;d<c.length;d++)if(a.clientId===c[d].clientId)return!0}return!1},disable:function(){this.enabled&&(a.world.unsubscribe(this.msgHandler,a.msg.pick),a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),this.enabled=!1)},enable:function(){this.enabled||(this.msgHandler=a.world.subscribe(a.msg.pick,this,"onPick",[a.dispatch.MSG_ARG+"data.pickInfo",a.dispatch.MSG_ARG+"data.mouseEvent"]),a.input.addMouseMoveListener(this),a.input.addMouseUpListener(this),this.enabled=!0)},getPlane:function(){if(this.activeTransform===null)return null;var b;if(this.local){var c=a.utils;b=[c.pointAsWorld(this.activeTransform,this.plane[0]),c.pointAsWorld(this.activeTransform,this.plane[1]),c.pointAsWorld(this.activeTransform,this.plane[2])]}else{var d=a.core.math,e=this.activeTransform.getUpdatedWorldMatrix(),f=e[3].slice(0,3);b=[d.addVector(this.plane[0],f),d.addVector(this.plane[1],f),d.addVector(this.plane[2],f)]}return b},getTransforms:function(){var a=[];for(var b=0,c=this.transformObjs.length;b<c;b++)a.push(this.transformObjs[b].transform);return a},getUV:function(b,c){var d=a.core.picking.clientPositionToWorldRay(b,c,a.view.viewInfo.drawContext,a.core.client.width,a.core.client.height),e=this.getPlane(),f=a.utils.intersect(d,e);return[f[1],f[2]]},onMouseMove:function(b){if(this.dragUV===null)return;var c=this.getUV(b.x,b.y),d=[c[0]-this.dragUV[0],c[1]-this.dragUV[1]],e=this.getPlane();d=this.clamp(d);var f=a.utils.uvToXYZ(d,e),g=a.utils.uvToXYZ([0,0],e),h=a.core.math.subVector(f,g);for(var i=0,j=this.transformObjs.length;i<j;i++){var k=this.transformObjs[i].transform;a.utils.worldTranslate(h,k)}this.send(a.msg.drag,{drag:h})},onMouseUp:function(a){this.activeTransform=null,this.dragUV=null},onPick:function(a,b){var d=a.shapeInfo.parent.transform;for(var e=0,f=this.transformObjs.length;e<f;e++)if(c(this.transformObjs[e].transform,d)){this.activeTransform=d,this.dragUV=this.getUV(b.x,b.y);break}},receiveTransform:function(a){this.addTransform(a)},removeTransforms:function(a){for(var c=0;c<this.transformObjs.length;++c){var d=this.transformObjs[c];a===d.owner&&(b.call(this,d),--c)}},setLimits:function(a){this.umin=a[0][0],this.umax=a[1][0],this.vmin=a[0][1],this.vmax=a[1][1]},setPlane:function(b){switch(b){case a.manip.Plane.XY:this.plane=[[0,0,0],[1,0,0],[0,1,0]];break;case a.manip.Plane.XZ:this.plane=[[0,0,0],[1,0,0],[0,0,1]];break;case a.manip.Plane.YZ:this.plane=[[0,0,0],[0,0,1],[0,1,0]];break;default:this.plane=b}},setToLocal:function(){this.local=!0},setToWorld:function(){this.local=!1}}),a.manip.Turnable=a.world.Citizen.extend({init:function(a,b,c){this._super(),this.angle=c==null?0:c,this.axis=null,this.activeTransform=null,this.dragAngle=null,this.enabled=!1,this.local=!1,this.min=null,this.max=null,this.msgHandler=null,this.plane=null,this.transformObjs=[],a!=null&&this.setAxis(a),b!=null&&this.setLimits(b),this.enable()},citizenType:"hemi.manip.Turnable",cleanup:function(){this.disable(),this._super(),this.clearTransforms(),this.msgHandler=null},toOctane:function(){var a=this._super(),b=["min","max"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a.props.push({name:"setAxis",arg:[this.axis]}),a},addTransform:function(b){a.world.tranReg.register(b,this);var c=b.getParam("ownerId"),d={},e=null;c!==null&&(e=a.world.getCitizenById(c.value)),a.utils.isAnimated(b)?(d.transform=a.utils.fosterTransform(b),d.foster=!0):(d.transform=b,d.foster=!1);if(e){var f=this;d.owner=e,d.msg=e.subscribe(a.msg.cleanup,function(a){f.removeTransforms(a.src)})}this.activeTransform=b,this.transformObjs.push(d)},clearLimits:function(){this.min=null,this.max=null},clearTransforms:function(){while(this.transformObjs.length>0)b.call(this,this.transformObjs[0]);this.activeTransform=null},containsTransform:function(a){for(var b=0;b<this.transformObjs.length;b++){var c=this.transformObjs[b].transform.getTransformsInTree();for(var d=0;d<c.length;d++)if(c[d].clientId===a.clientId)return!0}return!1},disable:function(){this.enabled&&(a.world.unsubscribe(this.msgHandler,a.msg.pick),a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),this.enabled=!1)},enable:function(){this.enabled||(this.msgHandler=a.world.subscribe(a.msg.pick,this,"onPick",[a.dispatch.MSG_ARG+"data.pickInfo",a.dispatch.MSG_ARG+"data.mouseEvent"]),a.input.addMouseMoveListener(this),a.input.addMouseUpListener(this),this.enabled=!0)},getAngle:function(b,c){if(this.activeTransform===null)return null;var d=a.core.picking.clientPositionToWorldRay(b,c,a.view.viewInfo.drawContext,a.core.client.width,a.core.client.height),e;if(this.local){var f=a.utils;e=[f.pointAsWorld(this.activeTransform,this.plane[0]),f.pointAsWorld(this.activeTransform,this.plane[1]),f.pointAsWorld(this.activeTransform,this.plane[2])]}else{var g=a.core.math,h=this.activeTransform.getUpdatedWorldMatrix(),i=h[3].slice(0,3);e=[g.addVector(this.plane[0],i),g.addVector(this.plane[1],i),g.addVector(this.plane[2],i)]}var j=a.utils.intersect(d,e);return Math.atan2(j[2],j[1])},getTransforms:function(){var a=[];for(var b=0,c=this.transformObjs.length;b<c;b++)a.push(this.transformObjs[b].transform);return a},onMouseMove:function(b){if(this.dragAngle===null)return;var c=this.getAngle(b.x,b.y)-this.dragAngle,d;this.max!=null&&this.angle+c>=this.max&&(c=this.max-this.angle),this.min!=null&&this.angle+c<=this.min&&(c=this.min-this.angle),this.angle+=c,this.local||(this.dragAngle+=c);switch(this.axis){case a.manip.Axis.X:d=[-1,0,0];break;case a.manip.Axis.Y:d=[0,-1,0];break;case a.manip.Axis.Z:d=[0,0,1]}for(var e=0;e<this.transformObjs.length;e++){var f=this.transformObjs[e].transform;this.local?f.axisRotate(d,c):a.utils.worldRotate(d,c,f)}},onMouseUp:function(a){this.dragAngle=null},onPick:function(a,b){this.containsTransform(a.shapeInfo.parent.transform)&&(this.activeTransform=a.shapeInfo.parent.transform,this.dragAngle=this.getAngle(b.x,b.y))},receiveTransform:function(a){this.addTransform(a)},removeTransforms:function(a){for(var c=0;c<this.transformObjs.length;++c){var d=this.transformObjs[c];a===d.owner&&(b.call(this,d),--c)}},setAxis:function(b){this.axis=b;switch(b){case a.manip.Axis.X:this.plane=[[0,0,0],[0,0,1],[0,1,0]];break;case a.manip.Axis.Y:this.plane=[[0,0,0],[1,0,0],[0,0,1]];break;case a.manip.Axis.Z:this.plane=[[0,0,0],[1,0,0],[0,1,0]]}},setLimits:function(a){a[0]!=null?this.min=a[0]:this.min=null,a[1]!=null?this.max=a[1]:this.max=null},setToLocal:function(){this.local=!0},setToWorld:function(){this.local=!1}}),a.manip.Scalable=a.world.Citizen.extend({init:function(a){this._super(),this.activeTransform=null,this.axis=null,this.dragAxis=null,this.dragOrigin=null,this.local=!1,this.scale=null,this.transformObjs=[],this.setAxis(a),this.enable()},addTransform:function(b){a.world.tranReg.register(b,this);var c=b.getParam("ownerId"),d={},e=null;c!==null&&(e=a.world.getCitizenById(c.value)),a.utils.isAnimated(b)?(d.transform=a.utils.fosterTransform(b),d.foster=!0):(d.transform=b,d.foster=!1);if(e){var f=this;d.owner=e,d.msg=e.subscribe(a.msg.cleanup,function(a){f.removeTransforms(a.src)})}this.transformObjs.push(d)},cleanup:function(){this.disable(),this._super(),this.clearTransforms(),this.msgHandler=null},clearTransforms:function(){while(this.transformObjs.length>0)b.call(this,this.transformObjs[0])},containsTransform:function(a){for(var b=0;b<this.transformObjs.length;b++){var c=this.transformObjs[b].transform.getTransformsInTree();for(var d=0;d<c.length;d++)if(a.clientId===c[d].clientId)return!0}return!1},disable:function(){this.enabled&&(a.world.unsubscribe(this.msgHandler,a.msg.pick),a.input.removeMouseMoveListener(this),a.input.removeMouseUpListener(this),this.enabled=!1)},enable:function(){this.enabled||(this.msgHandler=a.world.subscribe(a.msg.pick,this,"onPick",[a.dispatch.MSG_ARG+"data.pickInfo",a.dispatch.MSG_ARG+"data.mouseEvent"]),a.input.addMouseMoveListener(this),a.input.addMouseUpListener(this),this.enabled=!0)},getScale:function(b,c){var d=a.core.math,e=[b-this.dragOrigin[0],c-this.dragOrigin[1]],f=Math.abs(a.core.math.dot(this.dragAxis,e));return f},onMouseMove:function(b){if(this.dragAxis===null)return;var c=this.getScale(b.x,b.y),d=c/this.scale,e=[this.axis[0]?d:1,this.axis[1]?d:1,this.axis[2]?d:1];for(i=0;i<this.transformObjs.length;i++){var f=this.transformObjs[i].transform;this.local?f.scale(e):a.utils.worldScale(e,f)}this.scale=c,this.send(a.msg.scale,{scale:c})},onMouseUp:function(){this.dragAxis=null,this.dragOrigin=null,this.scale=null},onPick:function(b,c){if(this.containsTransform(b.shapeInfo.parent.transform)){this.activeTransform=b.shapeInfo.parent.transform;var d=this.xyPoint(this.axis);this.dragOrigin=this.xyPoint([0,0,0]),this.dragAxis=a.core.math.normalize([d[0]-this.dragOrigin[0],d[1]-this.dragOrigin[1]]),this.scale=this.getScale(c.x,c.y)}},removeTransforms:function(a){for(var c=0;c<this.transformObjs.length;++c){var d=this.transformObjs[c];a===d.owner&&(b.call(this,d),--c)}},setAxis:function(b){switch(b){case a.manip.Axis.X:this.axis=[1,0,0];break;case a.manip.Axis.Y:this.axis=[0,1,0];break;case a.manip.Axis.Z:this.axis=[0,0,1];break;default:this.axis=[0,0,0]}},setToLocal:function(){this.local=!0},setToWorld:function(){this.local=!1},xyPoint:function(b){if(this.activeTransform===null)return null;var c=a.utils,d;if(this.local)d=c.pointAsWorld(this.activeTransform,b);else{var e=this.activeTransform.getUpdatedWorldMatrix(),f=e[3].slice(0,3);d=a.core.math.addVector(b,f)}return c.worldToScreenFloat(d)}}),a.manip.Draggable.prototype.msgSent=a.manip.Draggable.prototype.msgSent.concat([a.msg.drag]),a.manip.Scalable.prototype.msgSent=a.manip.Scalable.prototype.msgSent.concat([a.msg.scale]);var b=function(b){var c;b.foster?c=a.utils.unfosterTransform(b.transform):c=b.transform,a.world.tranReg.unregister(c,this);var d=this.transformObjs.indexOf(b);d>-1&&this.transformObjs.splice(d,1),b.owner&&b.msg&&b.owner.unsubscribe(b.msg,a.msg.cleanup)};return a}(hemi||{}),hemi=function(a){a.curve=a.curve||{},a.curve.CurveType={Linear:0,Bezier:1,CubicHermite:2,LinearNorm:3,Cardinal:4,Custom:5},a.curve.ShapeType={CUBE:"cube",SPHERE:"sphere",ARROW:"arrow"},a.curve.Box=function(a,b){this.min=a||[],this.max=b||[]},a.curve.ColorKey=function(a,b){this.key=a,this.value=b},a.curve.ScaleKey=function(a,b){this.key=a,this.value=b},a.curve.drawCurve=function(b,c){this.dbgLineMat||(this.dbgLineMat=this.newMaterial("phong",!1),this.dbgLineMat.getParam("lightWorldPos").bind(a.world.camera.light.position));var d=c.edges==null?!0:c.edges,e=c.edgeSize||1,f=c.edgeColor||[.5,0,0,1],g=c.joints==null?!0:c.joints,h=c.jointSize||1,i=c.jointColor,j=this.pack.createObject("Transform");for(var k=0;k<b.length;k++){if(g){var l=this.pack.createObject("Transform"),m=a.core.primitives.createSphere(this.pack,this.dbgLineMat,h,20,20);l.parent=j,l.addShape(m),l.translate(b[k]);if(i){var n=l.createParam("diffuse","o3d.ParamFloat4");n.value=i}}if(d&&k<b.length-1){var o=this.drawLine(b[k],b[k+1],e,f);o.parent=j}}j.parent=a.core.client.root,this.dbgLineTransforms.push(j)},a.curve.drawLine=function(b,c,d,e){this.dbgLineMat||(this.dbgLineMat=this.newMaterial("phong",!1),this.dbgLineMat.getParam("lightWorldPos").bind(a.world.camera.light.position));var f=d||1,g=a.core.math.distance(b,c),h=[(b[0]+c[0])/2,(b[1]+c[1])/2,(b[2]+c[2])/2],i=a.core.primitives.createCylinder(this.pack,this.dbgLineMat,f,g,3,1),j=this.pack.createObject("Transform");j.addShape(i),j.translate(h),j=a.utils.pointYAt(j,h,b);if(e){var k=j.createParam("diffuse","o3d.ParamFloat4");k.value=e}return j},a.curve.hideCurves=function(a){if(a){var b=a.children,c=a.shapes;for(var d=0;d<b.length;d++)this.hideCurves(b[d]);for(var d=0;d<c.length;d++){var e=c[d];a.removeShape(e),this.pack.removeObject(e)}a.parent=null,this.pack.removeObject(a)}else{for(var d=0;d<this.dbgLineTransforms.length;d++)this.hideCurves(this.dbgLineTransforms[d]);this.dbgLineTransforms=[]}},a.curve.randomPoint=function(a,b){var c=Math.random(),d=Math.random(),e=Math.random(),f=c*a[0]+(1-c)*b[0],g=d*a[1]+(1-d)*b[1],h=e*a[2]+(1-e)*b[2];return[f,g,h]},a.curve.showBoxes=function(b,c){c=c||a.picking.pickRoot;var d=a.curve.pack,e=this.dbgBoxTransforms[c.clientId]||[];for(var f=0;f<b.length;f++){var g=d.createObject("Transform"),h=b[f],i=h.max[0]-h.min[0],j=h.max[1]-h.min[1],k=h.max[2]-h.min[2],l=h.min[0]+i/2,m=h.min[1]+j/2,n=h.min[2]+k/2,o=o3djs.primitives.createBox(d,this.dbgBoxMat,i,j,k);g.addShape(o),g.translate(l,m,n),g.parent=c,e.push(g)}this.dbgBoxTransforms[c.clientId]=e},a.curve.hideBoxes=function(b){var c=a.curve.pack;if(b){var d=this.dbgBoxTransforms[b.clientId]||[];for(var e=0;e<d.length;e++){var f=d[e],g=f.shapes[0];f.parent=null,f.removeShape(g),c.removeObject(g),c.removeObject(f)}delete this.dbgBoxTransforms[b.clientId]}else for(var h in this.dbgBoxTransforms)this.hideBoxes({clientId:h})},a.curve.createSystem=function(b){var c;return b.fast?b.trail?c=new a.curve.GpuParticleTrail(b):c=new a.curve.GpuParticleSystem(b):c=new a.curve.ParticleSystem(b),c},a.curve.newMaterial=function(b,c){var d=c==null?!0:c,e;switch(b){case"constant":e=a.core.material.createConstantMaterial(this.pack,a.view.viewInfo,[0,0,0,1],d);break;case"lambert":e=a.core.material.createLambertMaterial(this.pack,a.view.viewInfo,[0,0,0,1],d);break;case"phong":default:e=a.core.material.createBasicMaterial(this.pack,a.view.viewInfo,[0,0,0,1],d)}return e},a.curve.init=function(){this.pack=a.core.client.createPack(),this.dbgBoxMat=a.core.material.createConstantMaterial(this.pack,a.view.viewInfo,[0,0,.5,1]),this.dbgLineMat=null;var b=this.pack.createObject("State");b.getStateParam("PolygonOffset2").value=-1,b.getStateParam("FillMode").value=a.core.o3d.State.WIREFRAME,this.dbgBoxMat.state=b,this.dbgBoxTransforms={},this.dbgLineTransforms=[]},a.curve.Curve=function(a,b,c){this.count=0,this.tension=0,this.type=b,this.weights=[],this.xpts=[],this.xtans=[],this.ypts=[],this.ytans=[],this.zpts=[],this.ztans=[],a&&(c=c||{},c.points=a,this.loadConfig(c))},a.curve.Curve.prototype={toOctane:function(){var a=["count","tension","weights","xpts","xtans","ypts","ytans","zpts","ztans"],b={type:"hemi.curve.Curve",props:[]};for(var c=0,d=a.length;c<d;c++){var e=a[c];b.props.push({name:e,val:this[e]})}return b.props.push({name:"setType",arg:[this.type]}),b},loadConfig:function(b){var c=b.points,d=b.type||this.type||a.curve.CurveType.Linear;this.setType(d);if(c){this.count=c.length;for(var e=0;e<this.count;e++)this.xpts[e]=c[e][0],this.ypts[e]=c[e][1],this.zpts[e]=c[e][2],this.xtans[e]=0,this.ytans[e]=0,this.ztans[e]=0,this.weights[e]=1}if(b.weights)for(var e=0;e<this.count;e++)this.weights[e]=b.weights[e]!=null?b.weights[e]:1;if(b.tangents)for(var e=0;e<this.count;e++)b.tangents[e]&&(this.xtans[e]=b.tangents[e][0]||0,this.ytans[e]=b.tangents[e][1]||0,this.ztans[e]=b.tangents[e][2]||0);b.tension&&(this.tension=b.tension),this.setTangents()},interpolate:function(a){return[a,a,a]},linear:function(a){var b=this.count-1,c=Math.floor(a*b);c>=b&&(c=b-1);var d=(a-c/b)/((c+1)/b-c/b),e=(1-d)*this.xpts[c]+d*this.xpts[c+1],f=(1-d)*this.ypts[c]+d*this.ypts[c+1],g=(1-d)*this.zpts[c]+d*this.zpts[c+1];return[e,f,g]},bezier:function(b){var c=0,d=0,e=0,f=0,g=this.count;for(var h=0;h<g;h++){var i=this.weights[h]*a.utils.choose(g-1,h)*Math.pow(b,h)*Math.pow(1-b,g-1-h);c+=i*this.xpts[h],d+=i*this.ypts[h],e+=i*this.zpts[h],f+=i}return[c/f,d/f,e/f]},cubicHermite:function(b){var c=this.count-1,d=Math.floor(b*c);d>=c&&(d=c-1);var e=(b-d/c)/((d+1)/c-d/c),f=a.utils.cubicHermite(e,this.xpts[d],this.xtans[d],this.xpts[d+1],this.xtans[d+1]),g=a.utils.cubicHermite(e,this.ypts[d],this.ytans[d],this.ypts[d+1],this.ytans[d+1]),h=a.utils.cubicHermite(e,this.zpts[d],this.ztans[d],this.zpts[d+1],this.ztans[d+1]);return[f,g,h]},linearNorm:function(b){var c=0,d=[];d[0]=0;for(var e=1;e<this.count;e++)c+=a.core.math.distance([this.xpts[e-1],this.ypts[e-1],this.zpts[e-1]],[this.xpts[e],this.ypts[e],this.zpts[e]]),d[e]=c;var f=b*c,g=0;for(var e=0;e<this.count;e++)d[e]<f&&(g=e);var h=(f-d[g])/(d[g+1]-d[g]),i=(1-h)*this.xpts[g]+h*this.xpts[g+1],j=(1-h)*this.ypts[g]+h*this.ypts[g+1],k=(1-h)*this.zpts[g]+h*this.zpts[g+1];return[i,j,k]},setTangents:function(){if(this.type==a.curve.CurveType.Cardinal){var b=a.utils.clone(this.xpts),c=a.utils.clone(this.ypts),d=a.utils.clone(this.zpts);b.unshift(b[0]),b.push(b[b.length-1]),c.unshift(c[0]),c.push(c[c.length-1]),d.unshift(d[0]),d.push(d[d.length-1]);for(var e=0;e<this.count;e++)this.xtans[e]=(1-this.tension)*(b[e+2]-b[e])/2,this.ytans[e]=(1-this.tension)*(c[e+2]-c[e])/2,this.ztans[e]=(1-this.tension)*(d[e+2]-d[e])/2}},setType:function(b){this.type=b;switch(b){case a.curve.CurveType.Linear:this.interpolate=this.linear;break;case a.curve.CurveType.Bezier:this.interpolate=this.bezier;break;case a.curve.CurveType.CubicHermite:case a.curve.CurveType.Cardinal:this.interpolate=this.cubicHermite;break;case a.curve.CurveType.LinearNorm:this.interpolate=this.linearNorm;break;case a.curve.CurveType.Custom:default:}},getEnd:function(){var a=this.count-1;return[this.xpts[a],this.ypts[a],this.zpts[a]]},getStart:function(){return[this.xpts[0],this.ypts[0],this.zpts[0]]},draw:function(b,c){var d=[];for(var e=0;e<b+2;e++)d[e]=this.interpolate(e/(b+1));a.curve.drawCurve(d,c)}},a.curve.Particle=function(b,c,d,e,f){var g=a.curve.pack,h=a.core.math.matrix4;this.transform=g.createObject("Transform"),this.transform.parent=b,this.frame=1,this.lastFrame=c.length-2,this.destroyed=!1,this.transform.createParam("diffuse","ParamFloat4").value=[0,0,0,0],this.lt=[],this.matrices=[],this.setColors(d);for(var i=this.frame;i<=this.lastFrame;i++){var j=h.translation(c[i]);f&&a.utils.pointYAt(j,c[i-1],c[i+1]),this.lt[i]=j}this.setScales(e),this.ready=!0,this.active=!1},a.curve.Particle.prototype={run:function(a){this.loops=a,this.ready=!1,this.active=!0},addShape:function(a){this.transform.addShape(a)},removeShapes:function(){for(var a=this.transform.shapes.length-1;a>=0;a--)this.transform.removeShape(this.transform.shapes[a])},setColors:function(a){this.colors=[];if(a){this.colorKeys=[];for(var b=0;b<a.length;b++){var c={},d=a[b];c.key=d.key;if(d.range){c.value=[];if(typeof d.range=="number"){var e=(Math.random()-.5)*2*d.range;for(var f=0;f<d.value.length;f++)c.value[f]=d.value[f]+e}else for(var f=0;f<d.value.length;f++)c.value[f]=d.value[f]+(Math.random()-.5)*2*d.range[f]}else c.value=d.value;this.colorKeys[b]=c}}else this.colorKeys=[{key:0,value:[0,0,0,1]},{key:1,value:[0,0,0,1]}];for(var b=1;b<=this.lastFrame;b++){var g=(b-1)/(this.lastFrame-2);this.colors[b]=this.lerpValue(g,this.colorKeys)}return this},setScales:function(b){var c=a.core.math.matrix4;this.scales=[];if(b){var d=[];for(var e=0;e<b.length;e++){var f={},g=b[e];f.key=g.key;if(g.range){f.value=[];if(typeof g.range=="number"){var h=(Math.random()-.5)*2*g.range;for(var i=0;i<g.value.length;i++)f.value[i]=g.value[i]+h}else for(var i=0;i<g.value.length;i++)f.value[i]=g.value[i]+(Math.random()-.5)*2*g.range[i]}else f.value=g.value;d[e]=f}}else d=[{key:0,value:[1,1,1]},{key:1,value:[1,1,1]}];for(var e=1;e<=this.lastFrame;e++){var j=(e-1)/(this.lastFrame-2);this.scales[e]=this.lerpValue(j,d),this.matrices[e]=c.scale(a.utils.clone(this.lt[e]),this.scales[e])}return this},translate:function(a,b,c){this.transform.translate(a,b,c)},lerpValue:function(a,b){var c=b.length-2;while(b[c].key>a)c--;var d=(a-b[c].key)/(b[c+1].key-b[c].key);return o3djs.math.lerpVector(b[c].value,b[c+1].value,d)},update:function(){if(!this.active)return;var a=this.frame;this.transform.getParam("diffuse").value=this.colors[a],this.transform.localMatrix=this.matrices[a],this.frame++,this.transform.visible=!0,this.frame>=this.lastFrame&&(this.frame=1,this.loops--,this.loops===0&&this.reset())},destroy:function(){if(this.destroyed)return;var b=this.transform;for(var c=b.shapes.length-1;c>=0;c--)b.removeShape(b.shapes[c]);a.curve.pack.removeObject(b),this.transform=null,this.curve=null,this.destroyed=!0},reset:function(){this.transform.visible=!1,this.loops=this.totalLoops,this.destroyed=!1,this.active=!1,this.ready=!0}},a.curve.ParticleSystem=function(b){var c=a.curve.pack,d=a.view.viewInfo;this.transform=c.createObject("Transform"),this.transform.parent=b.parent||a.core.client.root,this.active=!1,this.pLife=b.life||5,this.boxes=b.boxes,this.maxParticles=b.particleCount||25,this.maxRate=Math.ceil(this.maxParticles/this.pLife),this.particles=[],this.pRate=this.maxRate,this.pTimer=0,this.pTimerMax=1/this.pRate,this.pIndex=0;var e=[1,0,0,1];this.shapeMaterial=o3djs.material.createBasicMaterial(c,d,e,!0);var f=this.shapeMaterial.getParam("lightWorldPos");f&&f.bind(a.world.camera.light.position);var g=b.particleShape||a.curve.ShapeType.CUBE,h=b.particleSize||1;this.shapes=[],this.size=h;switch(g){case a.curve.ShapeType.ARROW:var i=h/2;this.shapes.push(a.core.primitives.createPrism(c,this.shapeMaterial,[[0,h],[-h,0],[-i,0],[-i,-h],[i,-h],[i,0],[h,0]],h));break;case a.curve.ShapeType.SPHERE:this.shapes.push(a.core.primitives.createSphere(c,this.shapeMaterial,h,24,12));break;case a.curve.ShapeType.CUBE:this.shapes.push(a.core.primitives.createCube(c,this.shapeMaterial,h))}a.view.addRenderListener(this),this.boxesOn=!1,this.points=[],this.frames=b.frames||this.pLife*a.view.FPS;for(var j=0;j<this.maxParticles;j++){var k=this.newCurve(b.tension||0);this.points[j]=[];for(var l=0;l<this.frames;l++)this.points[j][l]=k.interpolate(l/this.frames)}var m=null,n=null;if(b.colorKeys)m=b.colorKeys;else if(b.colors){var o=b.colors.length,p=o===1?1:1/(o-1);m=[];for(var l=0;l<o;l++)m.push({key:l*p,value:b.colors[l]})}if(b.scaleKeys)n=b.scaleKeys;else if(b.scales){var o=b.scales.length,p=o===1?1:1/(o-1);n=[];for(var l=0;l<o;l++)n.push({key:l*p,value:b.scales[l]})}for(l=0;l<this.maxParticles;l++){this.particles[l]=new a.curve.Particle(this.transform,this.points[l],m,n,b.aim);for(var j=0;j<this.shapes.length;j++)this.particles[l].addShape(this.shapes[j])}},a.curve.ParticleSystem.prototype={start:function(){this.active=!0},stop:function(a){this.active=!1;if(a)for(var b=0;b<this.maxParticles;b++)this.particles[b]!=null&&this.particles[b].reset()},onRender:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b]!=null&&this.particles[b].update(a);if(!this.active)return;this.pTimer+=a.elapsedTime;if(this.pTimer>=this.pTimerMax){this.pTimer=0;var c=this.particles[this.pIndex];c.ready&&c.run(1),this.pIndex++,this.pIndex>=this.maxParticles&&(this.pIndex=0)}},newCurve:function(b){var c=[],d=this.boxes.length;for(var e=0;e<d;e++){var f=this.boxes[e].min,g=this.boxes[e].max;c[e+1]=a.curve.randomPoint(f,g)}c[0]=c[1].slice(0,3),c[d+1]=c[d].slice(0,3);var h=new a.curve.Curve(c,a.curve.CurveType.Cardinal,{tension:b});return h},removeShapes:function(){for(var a=0;a<this.maxParticles;a++)this.particles[a].removeShapes();this.shapes=[]},addShape:function(b){var c=a.curve.pack,d=this.shapes.length;if(typeof b=="string"){var e=this.size;switch(b){case a.curve.ShapeType.ARROW:var f=e/2;this.shapes.push(a.core.primitives.createPrism(c,this.shapeMaterial,[[0,e],[-e,0],[-f,0],[-f,-e],[f,-e],[f,0],[e,0]],e));break;case a.curve.ShapeType.SPHERE:this.shapes.push(a.core.primitives.createSphere(c,this.shapeMaterial,e,24,12));break;case a.curve.ShapeType.CUBE:this.shapes.push(a.core.primitives.createCube(c,this.shapeMaterial,e))}}else this.shapes.push(b);for(var g=0;g<this.maxParticles;g++)for(var h=d;h<this.shapes.length;h++)this.particles[g].addShape(this.shapes[h])},changeRate:function(a){return this.setRate(this.pRate+a)},setRate:function(b){var c=a.utils.clamp(b,0,this.maxRate);return c===0?(this.pTimerMax=0,this.stop()):(this.pRate===0&&c>0&&this.start(),this.pTimerMax=1/c),this.pRate=c,c},setColors:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b].setColors(a);return this},setScales:function(a){for(var b=0;b<this.maxParticles;b++)this.particles[b].setScales(a);return this},showBoxes:function(){a.curve.showBoxes(this.boxes,this.transform)},hideBoxes:function(){a.curve.hideBoxes(this.transform)},translate:function(a,b,c){this.transform.translate(a,b,c)}},a.curve.vertHeader="uniform float sysTime; \nuniform float ptcMaxTime; \nuniform float ptcDec; \nuniform float numPtcs; \nuniform float tension; \nuniform vec3 minXYZ[NUM_BOXES]; \nuniform vec3 maxXYZ[NUM_BOXES]; \nuniform mat4 viewProjection; \nattribute vec4 TEXCOORD; \nvarying vec4 ptcColor; \n",a.curve.vertHeaderColors="uniform vec4 ptcColors[NUM_COLORS]; \nuniform float ptcColorKeys[NUM_COLORS]; \n",a.curve.vertHeaderScales="uniform vec3 ptcScales[NUM_SCALES]; \nuniform float ptcScaleKeys[NUM_SCALES]; \n",a.curve.vertSupport="float rand(vec2 co) { \n  return fract(sin(dot(co.xy, vec2(12.9898,78.233))) * 43758.5453); \n} \nvec3 randXYZ(vec2 co, vec3 min, vec3 max) { \n  float rX = rand(vec2(co.x, co.x)); \n  float rY = rand(vec2(co.y, co.y)); \n  float rZ = rand(co); \n  return vec3(mix(max.x, min.x, rX), \n              mix(max.y, min.y, rY), \n              mix(max.z, min.z, rZ)); \n} \nvec3 ptcInterp(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float t2 = pow(t, 2.0); \n  float t3 = pow(t, 3.0); \n  return (2.0*t3 - 3.0*t2 + 1.0)*p0 + (t3 -2.0*t2 + t)*m0 + \n   (-2.0*t3 + 3.0*t2)*p1 + (t3-t2)*m1; \n} \n",a.curve.vertSupportColors="void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_COLORS-1; i++) { \n      if (ptcColorKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcColorKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcColorKeys[ndx+1] - key); \n    ptcColor = mix(ptcColors[ndx], ptcColors[ndx+1], t); \n  } \n} \n",a.curve.vertSupportNoColors="void setPtcClr(float ptcTime) { \n  if (ptcTime > 1.0) { \n    ptcColor = vec4(0.0); \n  } else { \n    ptcColor = vec4(1.0); \n  } \n} \n",a.curve.vertSupportAim="mat4 getRotMat(float t, vec3 p0, vec3 p1, vec3 m0, vec3 m1) { \n  float tM = max(0.0,t-0.02); \n  float tP = min(1.0,t+0.02); \n  vec3 posM = ptcInterp(tM, p0, p1, m0, m1); \n  vec3 posP = ptcInterp(tP, p0, p1, m0, m1); \n  vec3 dPos = posP-posM; \n  float dxz = sqrt(pow(dPos.x,2.0)+pow(dPos.z,2.0)); \n  float dxyz = length(dPos); \n  float cx = dPos.y/dxyz; \n  float cy = dPos.z/dxz; \n  float sx = dxz/dxyz; \n  float sy = dPos.x/dxz; \n  return mat4(cy,0.0,-1.0*sy,0.0, \n   sx*sy,cx,sx*cy,0.0, \n   cx*sy,-1.0*sx,cx*cy,0.0, \n   0.0,0.0,0.0,1.0); \n} \n",a.curve.vertSupportScale="vec3 getScale(float ptcTime) { \n  if (ptcTime > 1.0) { \n    return vec3(1.0); \n  } else { \n    int ndx; \n    float key; \n    for (int i = 0; i < NUM_SCALES-1; i++) { \n      if (ptcScaleKeys[i] < ptcTime) { \n        ndx = i; \n        key = ptcScaleKeys[i]; \n      } \n    } \n    float t = (ptcTime - key)/(ptcScaleKeys[ndx+1] - key); \n    return mix(ptcScales[ndx], ptcScales[ndx+1], t); \n  } \n} \n",a.curve.vertBodySetup="  float id = TEXCOORD[0]; \n  float offset = TEXCOORD[1]; \n  vec2 seed = vec2(id, numPtcs-id); \n  float ptcTime = sysTime + offset; \n  if (ptcTime > ptcMaxTime) { \n    ptcTime -= ptcDec; \n  } \n  setPtcClr(ptcTime); \n  if (ptcTime > 1.0) { \n    ptcTime = 0.0; \n  } \n  float boxT = float(NUM_BOXES-1)*ptcTime; \n  int ndx = int(floor(boxT)); \n  float t = fract(boxT); \n  vec3 p0 = randXYZ(seed,minXYZ[ndx],maxXYZ[ndx]); \n  vec3 p1 = randXYZ(seed,minXYZ[ndx+1],maxXYZ[ndx+1]); \n  vec3 m0; \n  vec3 m1; \n  if (ndx == 0) { \n    m0 = vec3(0,0,0); \n  } else { \n    vec3 pm1 = randXYZ(seed,minXYZ[ndx-1],maxXYZ[ndx-1]); \n    m0 = (p1-pm1)*tension; \n  } \n  if (ndx == NUM_BOXES-2) { \n    m1 = vec3(0,0,0); \n  } else { \n    vec3 p2 = randXYZ(seed,minXYZ[ndx+2],maxXYZ[ndx+2]); \n    m1 = (p2-p0)*tension; \n  } \n  vec3 pos = ptcInterp(t, p0, p1, m0, m1); \n  mat4 tMat = mat4(1.0,0.0,0.0,0.0, \n   0.0,1.0,0.0,0.0, \n   0.0,0.0,1.0,0.0, \n   pos.x,pos.y,pos.z,1.0); \n  mat4 tMatIT = mat4(1.0,0.0,0.0,-1.0*pos.x, \n   0.0,1.0,0.0,-1.0*pos.y, \n   0.0,0.0,1.0,-1.0*pos.z, \n   0.0,0.0,0.0,1.0); \n",a.curve.vertBodyAim="  mat4 rMat = getRotMat(t, p0, p1, m0, m1); \n",a.curve.vertBodyNoAim="  mat4 rMat = mat4(1.0); \n",a.curve.vertBodyScale="  vec3 scale = getScale(ptcTime); \n  mat4 sMat = mat4(scale.x,0.0,0.0,0.0, \n   0.0,scale.y,0.0,0.0, \n   0.0,0.0,scale.z,0.0, \n   0.0,0.0,0.0,1.0); \n",a.curve.vertBodyNoScale="  mat4 sMat = mat4(1.0); \n",a.curve.vertBodyEnd="  mat4 ptcWorld = tMat*rMat*sMat; \n  mat4 ptcWorldIT = tMatIT*rMat*sMat; \n  mat4 ptcWorldVP = viewProjection * ptcWorld; \n",a.curve.fragHeader="varying vec4 ptcColor; \n",a.curve.fragPreBody="  if (ptcColor.a == 0.0) {\n    discard;\n  }\n",a.curve.fragGlobNoColors="gl_FragColor.a *= ptcColor.a; \n",a.curve.GpuParticleSystem=a.world.Citizen.extend({init:function(a){this._super(),this.active=!1,this.aim=!1,this.boxes=[],this.colors=[],this.decParam=null,this.life=0,this.material=null,this.materialSrc=null,this.maxTimeParam=null,this.particles=0,this.ptcShape=0,this.scales=[],this.size=0,this.tension=0,this.texNdx=-1,this.timeParam=null,this.transform=null,a&&this.loadConfig(a)},citizenType:"hemi.curve.GpuParticleSystem",hideBoxes:function(){a.curve.hideBoxes(this.transform)},loadConfig:function(b){this.aim=b.aim==null?!1:b.aim,this.boxes=b.boxes?a.utils.clone(b.boxes):[],this.life=b.life||5,this.particles=b.particleCount||1,this.size=b.particleSize||1,this.tension=b.tension||0,b.colorKeys?this.setColorKeys(b.colorKeys):b.colors?this.setColors(b.colors):this.colors=[],b.scaleKeys?this.setScaleKeys(b.scaleKeys):b.scales?this.setScales(b.scales):this.scales=[],this.setMaterial(b.material||a.curve.newMaterial()),this.setParticleShape(b.particleShape||a.curve.ShapeType.CUBE)},onRender:function(a){var b=a.elapsedTime/this.life,c=this.timeParam.value+b;while(c>1)--c;this.timeParam.value=c},pause:function(){this.active&&(a.view.removeRenderListener(this),this.active=!1)},play:function(){this.active||(this.maxTimeParam.value===1?(a.view.addRenderListener(this),this.active=!0):this.start())},setAim:function(a){this.aim!==a&&(this.aim=a,this.setupShaders())},setBoxes:function(b){var d=this.boxes.length;this.boxes=a.utils.clone(b),this.boxes.length===d?c(this.material,this.boxes):this.setupShaders()},setColors:function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;e++)d.push({key:e*c,value:a[e]});this.setColorKeys(d)},setColorKeys:function(a){var b=a.length;if(b===1){var c=a[0].value;this.colors=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[a.length-1].key=1,this.colors=a):this.colors=[];this.setupShaders()},setLife:function(a){a>0&&(this.life=a)},setMaterial:function(b){var c=a.utils.getShaders(b);this.material&&a.curve.pack.removeObject(this.material),this.material=b,this.materialSrc={frag:c.fragSrc,vert:c.vertSrc},this.setupShaders()},setParticleCount:function(a){this.particles=a,this.ptcShape&&this.setParticleShape(this.ptcShape)},setParticleSize:function(a){this.size=a,this.ptcShape&&this.setParticleShape(this.ptcShape)},setParticleShape:function(c){this.ptcShape=c,this.transform&&(this.transform.parent=null,a.shape.pack.removeObject(this.transform.shapes[0]),a.shape.pack.removeObject(this.transform),this.transform=null),this.material=this.material||a.curve.newMaterial(),this.particles=this.particles||1;switch(c){case a.curve.ShapeType.ARROW:this.transform=a.shape.create({shape:"arrow",mat:this.material,size:this.size,tail:this.size});break;case a.curve.ShapeType.SPHERE:this.transform=a.shape.create({shape:"sphere",mat:this.material,radius:this.size});break;case a.curve.ShapeType.CUBE:default:this.transform=a.shape.create({shape:"cube",mat:this.material,size:this.size})}var d=this.transform.shapes[0],e=d.elements;for(var f=0,g=e.length;f<g;f++){var h=e[f];h.className==="Primitive"&&(this.texNdx=b(h,this.particles))}this.setupShaders()},setScales:function(a){var b=a.length,c=b===1?1:1/(b-1),d=[];for(var e=0;e<b;e++)d.push({key:e*c,value:a[e]});this.setScaleKeys(d)},setScaleKeys:function(a){var b=a.length;if(b===1){var c=a[0].value;this.scales=[{key:0,value:c},{key:1,value:c}]}else b>1?(a[0].key=0,a[b-1].key=1,this.scales=a):this.scales=[];this.setupShaders()},setTension:function(a){this.tension=a,this.material&&(this.material.getParam("tension").value=(1-this.tension)/2)},setupShaders:function(){if(!this.material||!this.materialSrc||this.texNdx===-1||this.boxes.length<2)return;var b=this.material,f=this.materialSrc.frag,g=this.materialSrc.vert,h=this.boxes.length,i=this.colors.length,j=this.scales.length,k=this.texNdx,l=i>1,m=j>1,n=a.utils.getShaders(b),o=n.fragShd,p=n.vertShd,q=1,r=3,s=1.1,t=["sysTime","ptcMaxTime","ptcDec","numPtcs","tension","ptcScales","ptcScaleKeys","minXYZ","maxXYZ","ptcColors","ptcColorKeys"];for(var u=0,v=t.length;u<v;u++){var w=t[u],x=b.getParam(w);x&&(w==="ptcDec"?q=x.value:w==="ptcMaxTime"?r=x.value:w==="sysTime"&&(s=x.value),b.removeParam(x))}if(g.search("ptcInterp")<0){var y=a.curve.vertHeader.replace(/NUM_BOXES/g,h),z=a.curve.vertSupport,A=a.curve.vertBodySetup.replace(/NUM_BOXES/g,h);y=y.replace(/TEXCOORD/g,"texCoord"+k),A=A.replace(/TEXCOORD/g,"texCoord"+k),l?(y+=a.curve.vertHeaderColors.replace(/NUM_COLORS/g,i),z+=a.curve.vertSupportColors.replace(/NUM_COLORS/g,i)):z+=a.curve.vertSupportNoColors,this.aim?(z+=a.curve.vertSupportAim,A+=a.curve.vertBodyAim):A+=a.curve.vertBodyNoAim,m?(y+=a.curve.vertHeaderScales.replace(/NUM_SCALES/g,j),z+=a.curve.vertSupportScale.replace(/NUM_SCALES/g,j),A+=a.curve.vertBodyScale):A+=a.curve.vertBodyNoScale,A+=a.curve.vertBodyEnd;var B=a.utils.parseSrc(g,"gl_Position"),C=B.body.replace(/world/g,"ptcWorld").replace(/ViewProjection/g,"VP").replace(/InverseTranspose/g,"IT");B.postHdr=y,B.postSprt=z,B.postHdr=y,B.preBody=A,B.body=C,g=a.utils.buildSrc(B),b.gl.detachShader(b.effect.program_,p),b.effect.loadVertexShaderFromString(g)}if(f.search("ptcColor")<0){var D=a.utils.parseSrc(f,"gl_FragColor"),E=D.glob;D.postHdr=a.curve.fragHeader,D.preBody=a.curve.fragPreBody,l?E.indexOf("diffuse")!==-1?D.glob=E.replace(/diffuse/g,"ptcColor"):D.glob=E.replace(/emissive/g,"ptcColor"):D.postGlob=a.curve.fragGlobNoColors,f=a.utils.buildSrc(D),b.gl.detachShader(b.effect.program_,o),b.effect.loadPixelShaderFromString(f)}b.effect.createUniformParameters(b),b.getParam("numPtcs").value=this.particles,b.getParam("tension").value=(1-this.tension)/2,this.decParam=b.getParam("ptcDec"),this.maxTimeParam=b.getParam("ptcMaxTime"),this.timeParam=b.getParam("sysTime"),this.decParam.value=q,this.maxTimeParam.value=r,this.timeParam.value=s,c(b,this.boxes);var F=!1,G=a.view.viewInfo;for(var u=0;u<i&&!F;u++)F=this.colors[u].value[3]<1;b.drawList=F?G.zOrderedDrawList:G.performanceDrawList,l&&d(b,this.colors),m&&e(b,this.scales)},showBoxes:function(){a.curve.showBoxes(this.boxes,this.transform)},start:function(){this.active||(this.active=!0,this.timeParam.value=1,this.maxTimeParam.value=1,a.view.addRenderListener(this))},stop:function(){this.active&&(this.active=!1,this.timeParam.value=1.1,this.maxTimeParam.value=3,a.view.removeRenderListener(this))},toOctane:function(){var a=this._super();return a.props.push({name:"loadConfig",arg:[{aim:this.aim,boxes:this.boxes,colorKeys:this.colors,life:this.life,particleCount:this.particles,particleShape:this.ptcShape,particleSize:this.size,scaleKeys:this.scales,tension:this.tension}]}),a},translate:function(a,b,d){for(var e=0,f=this.boxes.length;e<f;e++){var g=this.boxes[e],h=g.min,i=g.max;h[0]+=a,i[0]+=a,h[1]+=b,i[1]+=b,h[2]+=d,i[2]+=d}c(this.material,this.boxes)}}),a.curve.GpuParticleTrail=a.curve.GpuParticleSystem.extend({init:function(a){this._super(a),this.endTime=1,this.starting=!1,this.stopping=!1},onRender:function(b){var c=b.elapsedTime/this.life,d=this.timeParam.value+c;if(d>this.endTime)if(this.stopping)this.active=!1,this.stopping=!1,this.maxTimeParam.value=3,a.view.removeRenderListener(this),d=1.1;else{this.starting&&(this.starting=!1,this.endTime=1,this.decParam.value=1,this.maxTimeParam.value=1);while(--d>this.endTime);}this.stopping&&(this.maxTimeParam.value+=c),this.timeParam.value=d},play:function(){this.active||(this.starting||this.stopping||this.maxTimeParam.value===1?(a.view.addRenderListener(this),this.active=!0):this.start())},start:function(){this.stopping&&(a.view.removeRenderListener(this),this.active=!1,this.stopping=!1),this.active||(this.active=!0,this.starting=!0,this.stopping=!1,this.endTime=2,this.decParam.value=2,this.maxTimeParam.value=2,this.timeParam.value=1,a.view.addRenderListener(this))},stop:function(a){this.active&&(a?this.endTime=-1:this.stopping||(this.endTime=this.timeParam.value+1),this.starting=!1,this.stopping=!0)}});var b=function(b,c){var d=a.core.o3d.Stream.TEXCOORD,e=b.indexBuffer,f=b.streamBank,g=f.vertexStreams,h=g[0].getMaxVertices_(),i=g[0].field.buffer,j=[],k=-1,l,m="GpuParticles",n=c/3,o=0,p=10;a.loader.createTask(m,i);do l=f.getVertexStream(d,++k);while(l!==null);var q=i.createField("FloatField",2);f.setVertexStream(d,k,q,0);for(var r=0,s=g.length;r<s;r++){var t=g[r];j.push({stream:t,vals:t.field.getAt(0,h)})}i.allocateElements(h*c),a.loader.updateTask(m,p);var u=e.array_,v=[];for(var r=0;r<c;r++){var w=r*h,x=r/c;for(var y=0,z=u.length;y<z;y++)v.push(u[y]+w);for(var y=0,z=j.length;y<z;y++){var A=j[y],B=A.vals,C=A.stream.field;C.setAt(w,B)}for(var y=0;y<h;y++)q.setAt(w+y,[r,x]);++o>=n&&(o=0,p+=30,a.loader.updateTask(m,p))}return e.set(v),b.numberPrimitives*=c,b.numberVertices*=c,a.loader.updateTask(m,100),k},c=function(b,c){var d=b.getParam("minXYZ"),e=b.getParam("maxXYZ"),f=a.curve.pack.createObject("ParamArray"),g=a.curve.pack.createObject("ParamArray");f.resize(c.length,"ParamFloat3"),g.resize(c.length,"ParamFloat3");for(var h=0,i=c.length;h<i;++h){var j=c[h];f.getParam(h).value=j.min,g.getParam(h).value=j.max}d.value=f,e.value=g},d=function(b,c){var d=b.getParam("ptcColors"),e=b.getParam("ptcColorKeys"),f=a.curve.pack.createObject("ParamArray"),g=a.curve.pack.createObject("ParamArray");f.resize(c.length,"ParamFloat4"),g.resize(c.length,"ParamFloat");for(var h=0,i=c.length;h<i;++h)f.getParam(h).value=c[h].value,g.getParam(h).value=c[h].key;d.value=f,e.value=g},e=function(b,c){var d=b.getParam("ptcScales"),e=b.getParam("ptcScaleKeys"),f=a.curve.pack.createObject("ParamArray"),g=a.curve.pack.createObject("ParamArray");f.resize(c.length,"ParamFloat3"),g.resize(c.length,"ParamFloat");for(var h=0,i=c.length;h<i;++h)f.getParam(h).value=c[h].value,g.getParam(h).value=c[h].key;d.value=f,e.value=g};return a}(hemi||{}),hemi=function(a){return a.sprite=a.sprite||{},a.sprite.header="uniform mat4 projection; \nuniform mat4 worldView; \n",a.sprite.vertBody="  vec4 pos = position + vec4(worldView[3].xyz,0); \n",a.sprite.vertGlob="  gl_Position = pos*projection; \n",a.sprite.init=function(){this.pack=a.core.client.createPack()},a.sprite.Sprite=function(b,c,d){var e=a.core,f=a.sprite.pack,g=a.view.viewInfo;this.material=f.createObject("Material"),this.material.createParam("emissiveSampler","o3d.ParamSampler"),e.material.attachStandardEffect(f,this.material,g,"constant"),this.material.getParam("o3d.drawList").value=g.zOrderedDrawList;var h=a.utils.getShaders(this.material);this.materialSrc={frag:h.fragSrc,vert:h.vertSrc};var i=e.math.matrix4.rotationX(Math.PI/2);this.plane=e.primitives.createPlane(f,this.material,b,c,1,1,i),this.transform=f.createObject("Transform"),this.transform.addShape(this.plane),this.parent(e.client.root),this.cycle=0,this.maxCycles=0,this.clock=0,this.period=1,this.running=!1,this.samplers=[],this.lookAtCam=!1,this.constSize=!1},a.sprite.Sprite.prototype={addFrame:function(b,c){a.loader.loadTexture(b,function(b){var d=a.sprite.pack.createObject("Sampler");d.texture=b,this.samplers.push(d),c&&c(this.samplers.length-1,this)},this)},constantSize:function(a){this.constSize=a},lookAtCamera:function(b){if(this.lookAtCam!==b){var c=this.material,d=a.utils.getShaders(c),e=d.vertShd,f=this.materialSrc.vert,g=[];for(var h=0,i=g.length;h<i;h++){var j=g[h],k=c.getParam(j);k&&c.removeParam(k)}b&&(f=a.utils.combineVertSrc(f,{postHdr:a.sprite.header,preBody:a.sprite.vertBody,glob:a.sprite.vertGlob})),c.gl.detachShader(c.effect.program_,e),c.effect.loadVertexShaderFromString(f),c.effect.createUniformParameters(c),this.lookAtCam=b}},onRender:function(a){var b=this.transform.getUpdatedWorldMatrix()[3].slice(0,3);!this.constSize;if(!this.running)return;this.clock+=a.elapsedTime,this.clock>=this.period&&(this.cycle++,this.cycle==this.maxCycles?this.stop():(this.setFrame(this.cycle),this.clock%=this.period))},parent:function(a){this.transform.parent=a},run:function(b){this.cycle=0,this.maxCycles=b||this.samplers.length,this.clock=0,this.setFrame(0),this.running=!0,a.view.addRenderListener(this)},setFrame:function(a){if(this.samplers.length>0){var b=a%this.samplers.length,c=this.samplers[b];this.material.getParam("emissiveSampler").value=c}},setPeriod:function(a){this.period=a},stop:function(){this.running=!1}},a}(hemi||{}),hemi=function(a){a.shape=a.shape||{},a.shape.BOX="box",a.shape.CUBE="cube",a.shape.SPHERE="sphere",a.shape.CYLINDER="cylinder",a.shape.CONE="cone",a.shape.ARROW="arrow",a.shape.TETRA="tetra",a.shape.OCTA="octa",a.shape.PYRAMID="pyramid",a.shape.CUSTOM="custom",a.shape.SHAPE_ROOT="ShapeRoot",a.shape.TransformUpdate=function(){this.localMatrix=null,this.visible=null,this.pickable=null},a.shape.TransformUpdate.prototype={apply:function(b){this.localMatrix!=null&&(b.localMatrix=this.localMatrix),this.pickable!=null&&a.picking.setPickable(b,this.pickable,!0),this.visible!=null&&(b.visible=this.visible)},isModified:function(){return this.localMatrix!=null||this.pickable!=null||this.visible!=null},reset:function(){this.localMatrix=this.pickable=this.visible=null},toOctane:function(){var a={type:"hemi.shape.TransformUpdate",props:[]},b=["localMatrix","visible","pickable"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return a}},a.shape.Shape=a.world.Citizen.extend({init:function(b){this._super(),this.color=null,this.dim={},this.shapeType=null,this.transform=null,this.tranUp=new a.shape.TransformUpdate,b!=null&&this.loadConfig(b),this.color&&this.shapeType&&this.create()},citizenType:"hemi.shape.Shape",cleanup:function(){this._super(),this.transform!==null&&c(this.transform),this.color=null,this.dim={},this.shapeType=null,this.transform=null,this.tranUp=null},toOctane:function(){var a=this._super(),b=["color","dim","shapeType"];for(var c=0,d=b.length;c<d;c++){var e=b[c];a.props.push({name:e,val:this[e]})}return this.tranUp.isModified()&&a.props.push({name:"tranUp",oct:this.tranUp.toOctane()}),a.props.push({name:"create",arg:[]}),a},change:function(d){this.loadConfig(d);var e=a.utils.join({shape:this.shapeType,color:this.color},this.dim),f=a.shape.create(e),g=this.transform,h=g.shapes.slice(0),i=f.shapes.slice(0);while(h.length===0)g=g.children[0],h=g.shapes;for(var j=0,k=i.length;j<k;j++)g.addShape(i[j]),f.removeShape(i[j]);for(var j=0,k=h.length;j<k;j++)f.addShape(h[j]),g.removeShape(h[j]);b(this.transform,this.color),c(f)},create:function(){var b=a.utils.join({shape:this.shapeType,color:this.color},this.dim);this.transform!==null&&c(this.transform),this.transform=a.shape.create(b),this.tranUp.apply(this.transform),this.setName(this.name),this.ownerId=this.transform.createParam("ownerId","o3d.ParamInteger"),this.ownerId.value=this.getId(),a.world.tranReg.distribute(this)},loadConfig:function(a){this.tranUp.reset(),this.dim={};for(t in a)t==="color"?this.color=a[t]:t==="type"?this.shapeType=a[t]:this.dim[t]=a[t]},setId:function(a){this._super(a),this.ownerId&&(this.ownerId.value=a)},setName:function(a){this.name=a,this.transform.name=this.name+" Transform",this.transform.shapes[0].name=this.name+" Shape"},getTransform:function(){return this.transform},rotate:function(b){var c=b.axis.toLowerCase(),d=b.rad;switch(c){case"x":this.transform.rotateX(d);break;case"y":this.transform.rotateY(d);break;case"z":this.transform.rotateZ(d)}this.tranUp.localMatrix=a.utils.clone(this.transform.localMatrix)},scale:function(b){this.transform.scale(b.x,b.y,b.z),this.tranUp.localMatrix=a.utils.clone(this.transform.localMatrix)},setPickable:function(b){a.picking.setPickable(this.transform,b.pick,!0),this.tranUp.pickable=b.pick?null:!1},setMatrix:function(b){this.transform.localMatrix=b,this.tranUp.localMatrix=a.utils.clone(b)},setVisible:function(a){this.transform.visible=a.vis,this.tranUp.visible=a.vis?null:!1},translate:function(b,c,d){this.transform!==null&&(this.transform.translate(b,c,d),this.tranUp.localMatrix=a.utils.clone(this.transform.localMatrix))}}),a.shape.init=function(){a.shape.root=a.core.mainPack.createObject("Transform"),a.shape.root.name=a.shape.SHAPE_ROOT,a.shape.root.parent=a.picking.pickRoot,a.shape.pack=a.core.mainPack,a.shape.material=a.core.material.createBasicMaterial(a.shape.pack,a.view.viewInfo,[0,0,0,1],!1),a.shape.transMaterial=a.core.material.createBasicMaterial(a.shape.pack,a.view.viewInfo,[0,0,0,1],!0),a.world.addCamCallback(function(b){var c=b.light.position,d=a.shape.material.getParam("lightWorldPos");d&&d.bind(c),d=a.shape.transMaterial.getParam("lightWorldPos"),d&&d.bind(c)})},a.shape.create=function(c){var d=null,e=c.shape,f=null,g;if(c.mat!=null){g=c.mat;var h=g.getParam("lightWorldPos");h&&h.bind(a.world.camera.light.position)}else f=c.color,f[3]<1?g=a.shape.transMaterial:g=a.shape.material;switch(e.toLowerCase()){case a.shape.BOX:d=a.shape.createBox(c.height!=null?c.height:c.h!=null?c.h:1,c.width!=null?c.width:c.w!=null?c.w:1,c.depth!=null?c.depth:c.d!=null?c.d:1,g);break;case a.shape.CUBE:d=a.shape.createCube(c.size!=null?c.size:1,g);break;case a.shape.SPHERE:d=a.shape.createSphere(c.radius!=null?c.radius:c.r!=null?c.r:1,g);break;case a.shape.CYLINDER:d=a.shape.createCylinder(c.radiusB!=null?c.radiusB:c.r1!=null?c.r1:c.radius!=null?c.radius:c.r!=null?c.r:1,c.radiusT!=null?c.radiusT:c.r2!=null?c.r2:c.radius!=null?c.radius:c.r!=null?c.r:1,c.height!=null?c.height:c.h!=null?c.h:1,g);break;case a.shape.CONE:d=a.shape.createCone(c.radius!=null?c.radius:c.r!=null?c.r:1,c.height!=null?c.height:c.h!=null?c.h:1,g);break;case a.shape.ARROW:d=a.shape.createArrow(c.size!=null?c.size:1,c.tail!=null?c.tail:1,g);break;case a.shape.TETRA:d=a.shape.createTetra(c.size!=null?c.size:1,g);break;case a.shape.OCTA:d=a.shape.createOcta(c.size!=null?c.size:1,g);break;case a.shape.PYRAMID:d=a.shape.createPyramid(c.height!=null?c.height:c.h!=null?c.h:1,c.width!=null?c.width:c.w!=null?c.w:1,c.depth!=null?c.depth:c.d!=null?c.d:1,g);break;case a.shape.CUSTOM:d=a.shape.createCustom(c.vertices!=null?c.vertices:c.v!=null?c.v:[[0,0,0]],g)}return d!==null&&f!=null&&b(d,f),d},a.shape.createBox=function(b,c,d,e){var f=a.shape.pack,g=f.createObject("Transform"),h=a.core.primitives.createBox(f,e,c,b,d);return g.parent=a.shape.root,g.addShape(h),g},a.shape.createCube=function(b,c){var d=a.shape.pack,e=d.createObject("Transform"),f=a.core.primitives.createBox(d,c,b,b,b);return e.parent=a.shape.root,e.addShape(f),e},a.shape.createCylinder=function(b,c,d,e){var f=a.shape.pack,g=f.createObject("Transform"),h=a.core.primitives.createTruncatedCone(f,e,b,c,d,24,1);return g.parent=a.shape.root,g.addShape(h),g},a.shape.createCone=function(b,c,d){var e=a.shape.pack,f=e.createObject("Transform"),g=a.core.primitives.createTruncatedCone(e,d,b,0,c,24,1);return f.parent=a.shape.root,f.addShape(g),f},a.shape.createSphere=function(b,c){var d=a.shape.pack,e=d.createObject("Transform"),f=a.core.primitives.createSphere(d,c,b,24,12);return e.parent=a.shape.root,e.addShape(f),e},a.shape.createArrow=function(b,c,d){var e=a.shape.pack,f=e.createObject("Transform"),g=b/2,h=a.core.primitives.createPrism(e,d,[[0,b],[-b,0],[-g,0],[-g,-c],[g,-c],[g,0],[b,0]],b);return f.parent=a.shape.root,f.addShape(h),f},a.shape.createTetra=function(b,c){var d=b/2,e=[[d,d,d],[-d,-d,d],[-d,d,-d],[d,-d,-d]],f=[[e[0],e[2],e[1]],[e[0],e[1],e[3]],[e[0],e[3],e[2]],[e[1],e[2],e[3]]];return trans=a.shape.createCustom(f,c),trans},a.shape.createOcta=function(b,c){var d=a.shape.pack,e=d.createObject("Transform"),f=a.shape.createTetra(b,c),g=a.shape.createTetra(b,c);return f.parent=e,g.parent=e,g.rotateY(Math.PI/2),e.parent=a.shape.root,e},a.shape.createPyramid=function(b,c,d,e){var f=b/2,g=c/2,h=d/2,i=[[g,-f,h],[-g,-f,h],[-g,-f,-h],[g,-f,-h],[0,f,0]];return verts=[[i[0],i[1],i[2]],[i[0],i[2],i[3]],[i[1],i[0],i[4]],[i[2],i[1],i[4]],[i[3],i[2],i[4]],[i[0],i[3],i[4]]],trans=a.shape.createCustom(verts,e),trans},a.shape.createCustom=function(b,c){var d=a.shape.pack,e=d.createObject("Transform"),f=a.core.primitives.createVertexInfo(),g=f.addStream(3,o3djs.base.o3d.Stream.POSITION),h=f.addStream(3,o3djs.base.o3d.Stream.NORMAL),i=f.addStream(2,o3djs.base.o3d.Stream.TEXCOORD,0);for(var j=0,k=b.length;j<k;j++){var l=a.core.math.cross(a.core.math.normalize([b[j][1][0]-b[j][0][0],b[j][1][1]-b[j][0][1],b[j][1][2]-b[j][0][2]]),a.core.math.normalize([b[j][2][0]-b[j][0][0],b[j][2][1]-b[j][0][1],b[j][2][2]-b[j][0][2]]));g.addElementVector(b[j][0]),h.addElementVector(l),i.addElement(0,1),g.addElementVector(b[j][1]),h.addElementVector(l),i.addElement(1,0),g.addElementVector(b[j][2]),h.addElementVector(l),i.addElement(0,0),f.addTriangle(j*3,j*3+1,j*3+2)}var m=f.createShape(d,c);return e.parent=a.shape.root,e.addShape(m),e};var b=function(a,c){var d=a.children,e=a.getParam("diffuse");e===null&&(e=a.createParam("diffuse","o3d.ParamFloat4")),e.value=c;for(var f=0,g=d.length;f<g;f++)b(d[f],c)},c=function(b){var d=b.children,e=b.shapes;b.parent=null;for(var f=0,g=d.length;f<g;f++)c(d[f]);for(var f=0,g=e.length;f<g;f++)a.shape.pack.removeObject(e[f]);a.shape.pack.removeObject(b)};return a}(hemi||{}),hemi=function(a){return a.fx=a.fx||{},a.fx.addFog=function(b){var c=b.gl,d=b.effect.program_,e=a.utils.getShaders(b),f=e.fragShd,g=e.fragSrc,h=e.vertShd,i=e.vertSrc;if(i.search("fog")<0){var j="uniform float fogStart;\nuniform float fogEnd;\nvarying float fogAlpha;\n",k="void setFogAlpha(float z) {\n  fogAlpha = (z - fogStart)/(fogEnd - fogStart);\n  fogAlpha = clamp(fogAlpha,0.0,1.0);\n}\n";vertGlob="setFogAlpha(gl_Position.z);\n",i=a.utils.combineVertSrc(i,{postHdr:j,postSprt:k,postGlob:vertGlob}),c.detachShader(d,h),b.effect.loadVertexShaderFromString(i)}if(g.search("fog")<0){var l="uniform vec4 fogColor;\nvarying float fogAlpha;\n",m="gl_FragColor = mix(gl_FragColor, fogColor, fogAlpha);\n";g=a.utils.combineFragSrc(g,{postHdr:l,postGlob:m}),c.detachShader(d,f),b.effect.loadPixelShaderFromString(g)}return b.effect.createUniformParameters(b),{start:b.getParam("fogStart"),end:b.getParam("fogEnd"),color:b.getParam("fogColor")}},a.fx.addOpacity=function(b){var c=b.gl,d=b.effect.program_,e=a.utils.getShaders(b),f=e.fragShd,g=e.fragSrc;if(g.search("opacity")<0){var h="uniform float opacity;\n",i="gl_FragColor.a *= opacity;\n";g=a.utils.combineFragSrc(g,{postHdr:h,postGlob:i}),c.detachShader(d,f),b.effect.loadPixelShaderFromString(g),b.effect.createUniformParameters(b),b.getParam("o3d.drawList").value=a.view.viewInfo.zOrderedDrawList}var j=b.getParam("opacity");return j.value=1,j},a.fx.create=function(b,c){switch(b.type){case"constant":if(b.texture)return a.fx.createConstantTexture(b.texture,c);c(a.core.material.createConstantMaterial(a.core.mainPack,a.view.viewInfo,b.color,b.color[3]<1));return;case"basic":if(b.texture)return a.fx.createBasicTexture(b.texture,c);c(a.core.material.createBasicMaterial(a.core.mainPack,a.view.viewInfo,b.color,b.color[3]<1));return}},a.fx.modify=function(b,c){switch(c.type){case"constant":b.effect=null;var d=b.getParam("diffuseSampler");if(d){var e=b.createParam("emissiveSampler","ParamSampler");e.value=d.value,b.removeParam(d)}return o3djs.material.attachStandardEffect(a.core.mainPack,b,a.view.viewInfo,"constant"),b}},a.fx.createConstantTexture=function(b,c){var d=o3djs.util.getCurrentURI()+b,e;a.core.io.loadTexture(a.core.mainPack,d,function(b,d){d?alert(d):(e=a.core.material.createConstantMaterial(a.core.mainPack,a.view.viewInfo,b),c(e))})},a.fx.createBasicTexture=function(b,c){var d=o3djs.util.getCurrentURI()+b,e;a.core.io.loadTexture(a.core.mainPack,d,function(b,d){d?alert(d):(e=a.core.material.createBasicMaterial(a.core.mainPack,a.view.viewInfo,b),c(e))})},a}(hemi||{}),hemi=function(a){return a.texture=a.texture||{},a.texture.TextureSampler=function(b){this.textureURL=b||"",this.value=a.core.mainPack.createObject("Sampler")},a.texture.TextureSet=function(a,b){this.samplers={length:0},this.count=a||0,this.callback=b||function(){}},a.texture.TextureSet.prototype={addTexture:function(a,b){this.count++,this.loadTexture(a,b)},addTextureSampler:function(a,b){this.count++,b.value.texture||this.loadTextureSampler(b),this.samplers[a]=b},getTextureSampler:function(a){return this.samplers[a]},getSamplerValue:function(a){return this.samplers[a].value},loadTexture:function(b,c){var d=new a.texture.TextureSampler(c);this.samplers[b]=d,this.loadTextureSampler(d)},loadTextureSampler:function(b){a.loader.loadTexture(b.textureURL,function(a){b.value.texture=a,this.samplers.length++,this.samplers.length===this.count&&this.callback(this.samplers)},this)}},a.texture.createTextureSet=function(b,c){var b=b||{},d=0,e;if(typeof Object.keys=="function")d=Object.keys(b).length;else for(var f in b)b.hasOwnProperty(f)&&d++;e=new a.texture.TextureSet(d,c);for(var g in b)e.loadTexture(g,b[g]);return e},a.texture.getUV=function(b){var c=b.streamBank.getVertexStream(a.core.o3d.Stream.TEXCOORD,0);return c?{field:c.field,uv:c.field.getAt(0,b.numberVertices)}:null},a.texture.reportUV=function(b){var c=a.texture.getUV(b).uv;console.log(b);for(var d=0;d<c.length;d+=3)console.log(c[d]+","+c[d+1]+","+c[d+2])},a.texture.scale=function(b,c,d){var e=a.texture.getUV(b);for(var f=0;f<e.uv.length;f+=e.field.numComponents)e.uv[f]*=c,e.uv[f+1]*=d;e.field.setAt(0,e.uv)},a.texture.translate=function(b,c,d){var e=a.texture.getUV(b);for(var f=0;f<e.uv.length;f+=e.field.numComponents)e.uv[f]+=c,e.uv[f+1]+=d;e.field.setAt(0,e.uv)},a.texture.rotate=function(b,c){var d=a.texture.getUV(b);for(var e=0;e<d.uv.length;e+=d.field.numComponents){var f=d.uv[e],g=d.uv[e+1];d.uv[e]=f*Math.cos(c)-g*Math.sin(c),d.uv[e+1]=f*Math.sin(c)+g*Math.cos(c)}d.field.setAt(0,d.uv)},a}(hemi||{}),hemi=function(a){a.time=a.time||{},a.time.Timer=a.world.Citizen.extend({init:function(){this._super(),this._started=null,this._time=0,this._timeId=null,this.startTime=1e3},citizenType:"hemi.time.Timer",cleanup:function(){this._super(),this._timeId!==null&&(clearTimeout(this._timeId),this._timeId=null,this._started=null)},pause:function(){if(this._timeId!==null){clearTimeout(this._timeId),this._timeId=null;var a=(new Date).getTime();this._time+=a-this._started}},reset:function(){this._started=null,this._time=0,this._timeId=null},resume:function(){this._timeId===null&&this._started!==null&&(this._timeId=setTimeout(b,this.startTime-this._time,this),this._started=(new Date).getTime())},start:function(){this._timeId!==null&&clearTimeout(this._timeId),this._time=0,this.send(a.msg.start,{time:this.startTime}),this._timeId=setTimeout(b,this.startTime,this),this._started=(new Date).getTime()},stop:function(){if(this._timeId!==null){clearTimeout(this._timeId);var b=(new Date).getTime();this._time+=b-this._started}if(this._started!==null){var c=this._time;this.reset(),this.send(a.msg.stop,{time:c})}},toOctane:function(){var a=this._super();return a.props.push({name:"startTime",val:this.startTime}),a}}),a.time.Timer.prototype.msgSent=a.time.Timer.prototype.msgSent.concat([a.msg.start,a.msg.stop]);var b=function(b){b.reset(),b.send(a.msg.stop,{time:b.startTime})};return a}(hemi||{})